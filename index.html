<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#2c003e" />
  <meta name="description" content="Ù„Ø¹Ø¨Ø© ØªÙØ§Ø¹Ù„ÙŠØ© Ø±ÙˆÙ…Ø§Ù†Ø³ÙŠØ© Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø°ÙƒØ±ÙŠØ§Øª ÙˆØ§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ù…Ù…ÙŠØ²Ø©" />
  <title>Ø±Ø­Ù„Ø© Ø­Ø¨Ù†Ø§: Ø³Ù„ÙŠÙ…Ø§Ù† & Ø­Ø¨ÙŠØ¨ØªÙŠ</title>

  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    :root {
      --primary: #d63384;
      --primary-dark: #a61e63;
      --bg-gradient-1: #1a0029;
      --bg-gradient-2: #390050;
      --card-bg: rgba(255, 255, 255, 0.08);
      --text-main: #ffffff;
      --success: #00e676;
      --error: #ff5252;
      --input-bg: rgba(0, 0, 0, 0.4);
      --border-radius: 20px;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      margin: 0;
      font-family: 'Tajawal', sans-serif;
      background: linear-gradient(135deg, var(--bg-gradient-1), var(--bg-gradient-2));
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow-x: hidden;
      padding: 15px;
    }

    body::before {
      content: '';
      position: fixed; inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
      pointer-events: none;
      z-index: -1;
    }

    .container { width: 100%; max-width: 520px; position: relative; padding-bottom: 60px; }

    .card {
      background: var(--card-bg);
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: var(--border-radius);
      padding: 24px;
      box-shadow: 0 15px 50px rgba(0,0,0,0.5);
      transition: transform 0.3s ease;
      animation: float 6s ease-in-out infinite;
    }

    @keyframes float {
      0% {transform: translateY(0px);}
      50% {transform: translateY(-10px);}
      100% {transform: translateY(0px);}
    }

    .btn {
      background: linear-gradient(45deg, var(--primary), var(--primary-dark));
      border: none; color: white; padding: 16px; border-radius: 16px;
      font-size: 16px; font-weight: 800; font-family: inherit; cursor: pointer;
      width: 100%; transition: 0.2s; margin-top: 15px;
      box-shadow: 0 5px 20px rgba(214, 51, 132, 0.4);
      position: relative; overflow: hidden;
      display: block;
    }
    .btn::after {
      content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: 0.5s;
    }
    .btn:hover::after { left: 100%; }
    .btn:active { transform: scale(0.97); }

    .btn-secondary { background: rgba(255,255,255,0.1); box-shadow: none; border: 1px solid rgba(255,255,255,0.1); }
    .btn-danger { background: rgba(255, 82, 82, 0.2); color: #ff8080; border: 1px solid #ff5252; box-shadow: none; }
    .btn-small { padding: 8px 15px; font-size: 13px; width: auto; display: inline-block; margin: 5px; }
    .btn-share { background: linear-gradient(45deg, #25D366, #128C7E); }

    input, textarea, select {
      width: 100%; padding: 15px; background: var(--input-bg);
      border: 1px solid rgba(255,255,255,0.1); border-radius: 14px;
      color: white; font-family: inherit; font-size: 16px; margin-bottom: 12px;
      outline: none; text-align: center;
    }
    input:focus, textarea:focus, select:focus { border-color: var(--primary); background: rgba(0,0,0,0.6); }

    .screen { display: none; opacity: 0; animation: fadeUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
    .screen.active { display: block; }
    @keyframes fadeUp { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }

    .progress-container { margin-bottom: 25px; position: relative; }
    .progress-bar { height: 8px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary), #ff80ab); width: 0%; transition: width 0.5s ease; }

    .pin-grid { display: flex; gap: 10px; justify-content: center; margin: 25px 0; direction: ltr; }
    .pin-input { width: 55px; height: 65px; font-size: 26px; border-radius: 16px; margin: 0; text-align:center; }

    .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 20px 0; }
    .option-card {
      background: rgba(255,255,255,0.05); padding: 18px; border-radius: 16px;
      text-align: center; cursor: pointer; border: 2px solid transparent;
      transition: 0.2s; font-weight: 600; user-select:none;
    }
    .option-card:active { transform: scale(0.95); }
    .option-card.selected { border-color: var(--primary); background: rgba(214, 51, 132, 0.15); font-weight: 800; }

    #toast {
      position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
      background: rgba(20, 20, 30, 0.95); padding: 15px 30px; border-radius: 50px;
      z-index: 9999; display: none; font-size: 15px; text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1);
      width: max-content; max-width: 90%;
    }
    #toast.success { border-color: var(--success); color: var(--success); }
    #toast.error { border-color: var(--error); color: var(--error); }

    .settings-btn, .stats-btn, .backup-btn, .back-btn {
      position: fixed;
      width: 45px; height: 45px; background: rgba(0,0,0,0.4);
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      cursor: pointer; z-index: 100; font-size: 22px; backdrop-filter: blur(5px);
      transition: 0.3s; border: none; color: white;
    }
    .settings-btn { top: 20px; left: 20px; }
    .stats-btn { top: 75px; left: 20px; }
    .backup-btn { top: 130px; left: 20px; }
    .back-btn { top: 20px; right: 20px; display: none; }
    .settings-btn:hover, .stats-btn:hover, .backup-btn:hover, .back-btn:hover { background: var(--primary); }
    .back-btn.visible { display: flex; }

    .admin-overlay {
      position: fixed; inset: 0; background: #1a1a2e; z-index: 2000;
      padding: 20px; overflow-y: auto; display: none;
    }
    .admin-overlay.open { display: block; animation: fadeIn 0.3s; }

    .stage-editor {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.1);
      margin-bottom: 12px; border-radius: 12px; overflow: hidden;
    }
    .stage-header {
      padding: 15px; display: flex; justify-content: space-between;
      align-items: center; cursor: pointer; background: rgba(255,255,255,0.02);
    }
    .stage-body {
      padding: 15px; display: none; border-top: 1px solid rgba(255,255,255,0.05);
    }
    .stage-editor.open .stage-body { display: block; }

    .confetti { position: fixed; width: 10px; height: 10px; animation: fall linear forwards; z-index: 9998; }
    @keyframes fall { to { transform: translateY(110vh) rotate(720deg); } }
    @keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
    @keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.1);} 100% {transform: scale(1);} }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin: 20px 0;
    }
    .stat-card {
      background: rgba(255,255,255,0.05);
      padding: 15px;
      border-radius: 12px;
      text-align: center;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .stat-value {
      font-size: 28px;
      font-weight: 900;
      color: var(--primary);
      margin-bottom: 5px;
    }
    .stat-label { font-size: 13px; opacity: 0.75; }

    .motivation-msg {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      padding: 30px;
      border-radius: 20px;
      z-index: 5000;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0,0,0,0.7);
      max-width: 90%;
      width: 350px;
    }
    .motivation-msg.show {
      animation: popIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
    }
    @keyframes popIn {
      0% { transform: translate(-50%, -50%) scale(0) rotate(-180deg); opacity: 0; }
      100% { transform: translate(-50%, -50%) scale(1) rotate(0deg); opacity: 1; }
    }
    .motivation-msg.hide { animation: popOut 0.3s ease forwards; }
    @keyframes popOut { to { transform: translate(-50%, -50%) scale(0); opacity: 0; } }

    .connection-status {
      position: fixed; bottom: 20px; right: 20px;
      background: rgba(0,0,0,0.7);
      padding: 8px 15px; border-radius: 20px;
      font-size: 12px; display: none; align-items: center; gap: 8px;
      z-index: 1000;
    }
    .connection-status.offline { display: flex; }
    .connection-dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: #ff5252; animation: blink 1s infinite;
    }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.35; } }

    .loader {
      display: none;
      position: fixed; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      width: 50px; height: 50px;
      border: 4px solid rgba(255,255,255,0.2);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      z-index: 10000;
    }
    @keyframes spin { to { transform: translate(-50%, -50%) rotate(360deg); } }

    @media (max-width: 600px) {
      .card { padding: 18px; }
      .options-grid { gap: 8px; }
      .option-card { padding: 14px; font-size: 14px; }
      .pin-input { width: 50px; height: 60px; font-size: 24px; }
      .stats-grid { grid-template-columns: 1fr; gap: 10px; }
    }
  </style>
</head>

<body>
  <div id="toast" role="status" aria-live="polite"></div>
  <div class="loader" id="loader" aria-label="Loading"></div>

  <div class="connection-status" id="connectionStatus">
    <div class="connection-dot"></div>
    <span>ØºÙŠØ± Ù…ØªØµÙ„</span>
  </div>

  <button class="settings-btn" type="button" onclick="requestAdminAccess()" aria-label="Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…">âš™ï¸</button>
  <button class="stats-btn" type="button" onclick="stats.show()" aria-label="Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª">ğŸ“Š</button>
  <button class="backup-btn" type="button" onclick="backup.show()" aria-label="Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ">ğŸ’¾</button>
  <button class="back-btn" id="backBtn" type="button" onclick="game.goBack()" aria-label="Ø±Ø¬ÙˆØ¹">â¬…ï¸</button>

  <div class="container" id="mainContainer">

    <div id="screen-start" class="screen active">
      <div class="card" style="text-align:center; padding-top:40px; padding-bottom:40px;">
        <div style="font-size:70px; margin-bottom:15px; animation:pulse 2s infinite;">ğŸ’â¤ï¸</div>
        <h1 style="margin:0; font-size:32px;">Ø±Ø­Ù„Ø© Ø­Ø¨Ù†Ø§</h1>
        <p style="opacity:0.85; margin:15px 0 30px; line-height:1.8; font-size:16px;">
          Ø£Ø¬Ù…Ù„ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®.. ÙˆØ£Ø­Ù„Ù‰ Ø§Ù„Ø°ÙƒØ±ÙŠØ§Øª.<br>
          Ù‡Ù„ ØªØªØ°ÙƒØ±ÙŠÙ† ÙƒÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„ ÙŠØ§ Ø¹Ù…Ø±ÙŠØŸ
        </p>
        <button class="btn" type="button" onclick="game.start()">Ù„Ù†Ø¨Ø¯Ø£ Ø§Ù„Ø±Ø­Ù„Ø© âœ¨</button>
      </div>
    </div>

    <div id="screen-game" class="screen">
      <div class="progress-container">
        <div class="progress-bar"><div class="progress-fill" id="progressBar"></div></div>
        <div style="display:flex; justify-content:space-between; font-size:12px; opacity:0.65; margin-top:8px;">
          <span id="stageCounter">1/12</span>
          <span onclick="game.restart()" style="cursor:pointer; text-decoration:underline;">Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</span>
        </div>
      </div>

      <div class="card">
        <h2 id="stageTitle" style="margin:0 0 5px 0; color:var(--primary); font-size:20px;"></h2>
        <img id="stageImg" alt="" style="width:100%; border-radius:12px; margin-bottom:15px; display:none;">

        <p id="stagePrompt" style="font-size:18px; line-height:1.6; white-space:pre-line; margin-bottom:20px; font-weight:600;"></p>

        <div style="background:rgba(255,255,255,0.05); padding:12px; border-radius:12px; font-size:14px; margin-bottom:20px; border-right:4px solid var(--primary);">
          ğŸ«¶ <b>Ù…Ù‡Ù…ØªÙƒ:</b> <span id="stageTask" style="opacity:0.92;"></span>
        </div>

        <div id="inputContainer"></div>

        <div style="display:flex; gap:10px; margin-top:25px;">
          <button class="btn btn-secondary" type="button" style="flex:1;" onclick="game.showHint()">ØªÙ„Ù…ÙŠØ­ØŸ</button>
          <button class="btn" type="button" style="flex:2; margin-top:0;" onclick="game.check()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</button>
        </div>
      </div>
    </div>

    <div id="screen-win" class="screen">
      <div class="card" style="text-align:center;">
        <div style="font-size:70px; margin-bottom:10px;">ğŸğŸ‘‘</div>
        <h1 style="color:var(--primary); margin-bottom:10px;">Ø£Ø­Ù„Ù‰ Ù…Ù† ÙŠØ¬Ø§ÙˆØ¨!</h1>
        <p style="opacity:0.92; line-height:1.6; font-size:17px;">
          ÙƒÙ„ Ù‡Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ù…Ù‡Ù…Ø©ØŒ Ø¨Ø³ ÙˆØ¬ÙˆØ¯Ùƒ Ø¨Ø­ÙŠØ§ØªÙŠ Ù‡Ùˆ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø£Ù‡Ù….<br>
          ÙˆØµÙ„ØªÙŠ Ù„Ù„ÙƒÙ†Ø² ÙŠØ§ Ù‚Ù„Ø¨ÙŠ.
        </p>

        <div style="background:rgba(255,255,255,0.05); padding:20px; border-radius:16px; margin:25px 0; border:1px dashed rgba(255,255,255,0.3);">
          <p style="margin:0 0 10px; font-size:14px; opacity:0.75;">Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±ÙŠØ© Ù„ÙØªØ­ Ø§Ù„Ù‡Ø¯ÙŠØ©:</p>
          <h2 style="margin:0; color:var(--success); letter-spacing:1px;">Ø£Ù†Ø§ Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø§Ø³ØªÙ„Ø§Ù…</h2>
        </div>

        <div class="stats-grid" style="margin:25px 0;">
          <div class="stat-card">
            <div class="stat-value" id="winAttempts">0</div>
            <div class="stat-label">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="winTime">00:00</div>
            <div class="stat-label">Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø³ØªØºØ±Ù‚</div>
          </div>
        </div>

        <button class="btn btn-share" type="button" onclick="stats.share()">Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù†ØªÙŠØ¬Ø© ğŸ“¤</button>
        <button class="btn btn-secondary" type="button" onclick="game.restart(true)">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
      </div>
    </div>

    <div id="screen-stats" class="screen">
      <div class="card">
        <h2 style="margin:0 0 20px 0; color:var(--primary); text-align:center;">ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h2>

        <div class="stats-grid">
          <div class="stat-card"><div class="stat-value" id="totalAttempts">0</div><div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª</div></div>
          <div class="stat-card"><div class="stat-value" id="correctAnswers">0</div><div class="stat-label">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©</div></div>
          <div class="stat-card"><div class="stat-value" id="wrongAnswers">0</div><div class="stat-label">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ø®Ø§Ø·Ø¦Ø©</div></div>
          <div class="stat-card"><div class="stat-value" id="hintsUsed">0</div><div class="stat-label">Ø§Ù„ØªÙ„Ù…ÙŠØ­Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©</div></div>
          <div class="stat-card"><div class="stat-value" id="totalTime">00:00</div><div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆÙ‚Øª</div></div>
          <div class="stat-card"><div class="stat-value" id="gamesCompleted">0</div><div class="stat-label">Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</div></div>
        </div>

        <button class="btn btn-danger" type="button" onclick="stats.reset()">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
        <button class="btn btn-secondary" type="button" onclick="stats.close()">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>

    <div id="screen-backup" class="screen">
      <div class="card">
        <h2 style="margin:0 0 20px 0; color:var(--primary); text-align:center;">ğŸ’¾ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</h2>

        <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:12px; margin-bottom:20px;">
          <p style="margin:0 0 10px; font-size:14px; opacity:0.85;">Ø§Ø­ÙØ¸ÙŠ ØªÙ‚Ø¯Ù…Ùƒ ÙÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø©:</p>
          <button class="btn" type="button" onclick="backup.export()">ğŸ“¥ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        </div>

        <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:12px; margin-bottom:20px;">
          <p style="margin:0 0 10px; font-size:14px; opacity:0.85;">Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù†Ø³Ø®Ø© Ø³Ø§Ø¨Ù‚Ø©:</p>
          <button class="btn btn-secondary" type="button" onclick="backup.import()">ğŸ“¤ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        </div>

        <div style="background:rgba(255,82,82,0.1); padding:15px; border-radius:12px; margin-bottom:20px; border:1px solid rgba(255,82,82,0.3);">
          <p style="margin:0; font-size:13px; opacity:0.95;">âš ï¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ ÙÙ‚Ø·</p>
        </div>

        <button class="btn btn-secondary" type="button" onclick="backup.close()">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>

  </div>

  <div id="adminPanel" class="admin-overlay" aria-hidden="true">
    <div class="container">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
        <h2 style="margin:0">ğŸ›  Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>
        <button class="btn-small btn-secondary" type="button" onclick="admin.close()">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>

      <div style="background:#232336; padding:15px; border-radius:16px; margin-bottom:20px;">
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn-small btn" type="button" onclick="admin.addStage()">+ Ø³Ø¤Ø§Ù„</button>
          <button class="btn-small btn" type="button" onclick="admin.editMotivations()">âœï¸ Ø±Ø³Ø§Ø¦Ù„ ØªØ­ÙÙŠØ²ÙŠØ©</button>
          <button class="btn-small btn-secondary" type="button" onclick="admin.exportData()">Ù†Ø³Ø®</button>
          <button class="btn-small btn-secondary" type="button" onclick="admin.importData()">Ù„ØµÙ‚</button>
          <button class="btn-small btn-danger" type="button" onclick="admin.resetFactory()">Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø£ØµÙ„ÙŠ</button>
        </div>
      </div>

      <div id="stagesList"></div>
      <div id="motivationsList" style="display:none;"></div>

      <button class="btn" type="button" style="margin-top:20px;" onclick="admin.save()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
      <br><br><br>
    </div>
  </div>

<script>
/* ===========================
   âœ… Config / Keys / Version
=========================== */
const APP_VERSION = 7;
const STORAGE = {
  data: `love_hunt_data_v${APP_VERSION}`,
  motivations: `love_hunt_motivations_v${APP_VERSION}`,
  progress: `love_hunt_progress_v${APP_VERSION}`,
  stats: `love_hunt_stats_v${APP_VERSION}`,
  allKeys() { return [this.data, this.motivations, this.progress, this.stats]; }
};

/* ===========================
   ğŸ” Helpers (Escape + Admin PIN hash)
=========================== */
function escapeHTML(str) {
  return String(str ?? '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

const ADMIN_PIN_HASH = "6bfefd82c23dd6030bf505daa3cb5c55c7d1a294c0b483a724bccdc8a73577b6";
const ADMIN_SALT = "love_hunt_admin_v7:";

async function sha256Hex(input) {
  if (!window.crypto?.subtle) return null;
  const enc = new TextEncoder();
  const data = enc.encode(input);
  const hashBuffer = await crypto.subtle.digest('SHA-256', data);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

/* ===========================
   ğŸ® Default Data
=========================== */
const DEFAULT_DATA = [
  { title: "1. Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ğŸ‘¶ğŸ»", type: "pin4", prompt: "ÙÙŠ Ø£ÙŠ Ø³Ù†Ø© Ù†ÙˆÙ‘Ø± Ø­Ø¨ÙŠØ¨Ùƒ Ø§Ù„Ø¯Ù†ÙŠØ§ØŸ\n(Ø³Ù†Ø© Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯)", answer: "1992", hint: "Ø§Ù„ØªØ³Ø¹ÙŠÙ†Ø§Øª..", task: "Ø§Ø±Ø³Ù„ÙŠ ØµÙˆØ±ØªÙŠ ÙˆØ§Ù†Ø§ ØµØºÙŠØ± Ø§Ø°Ø§ Ø¹Ù†Ø¯Ùƒ (Ø£Ùˆ Ø§ÙŠÙ…ÙˆØ¬ÙŠ Ø·ÙÙ„)", successMsg: "Ø§Ù„Ø¹Ù…Ø± ÙƒÙ„Ù‡ ÙŠØ§ Ø±Ø¨ â¤ï¸" },
  { title: "2. Ø£ÙˆÙ„ ØªÙˆØ§ØµÙ„ ğŸ“±", type: "pin4", prompt: "Ù…ØªÙ‰ ÙƒØ§Ù† Ø£ÙˆÙ„ ØªÙˆØ§ØµÙ„ Ø¨ÙŠÙ†Ø§ØŸ\nØ§ÙƒØªØ¨ÙŠ Ø§Ù„ÙŠÙˆÙ… ÙˆØ§Ù„Ø´Ù‡Ø± (ÙŠÙˆÙ… 13 Ø´Ù‡Ø± 4).\nÙ…Ø«Ø§Ù„: 1304", answer: "1304", hint: "Ø´Ù‡Ø± Ø£Ø¨Ø±ÙŠÙ„.. ÙŠÙˆÙ… 13", task: "ØµÙˆØ±ÙŠ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø­ÙŠÙ† ÙˆØ§Ø±Ø³Ù„ÙŠÙ‡Ø§ Ù„ÙŠ ğŸ˜‰", successMsg: "Ù…Ø§ Ù†Ø³ÙŠØªÙŠ! ÙŠØ§ Ø²ÙŠÙ† Ø§Ù„Ø°Ø§ÙƒØ±Ø© ğŸ˜" },
  { title: "3. ÙƒÙ„Ù…Ø§Øª Ù„Ø§ ØªÙÙ†Ø³Ù‰ ğŸ’¬", type: "text", prompt: "ÙˆØ´ Ù‡ÙŠ Ø£ÙˆÙ„ Ø¬Ù…Ù„Ø© Ù‚Ù„ØªÙ‡Ø§ Ù„Ùƒ Ø¨Ø¹Ø¯ Ø±Ø¯ Ø§Ù„Ø³Ù„Ø§Ù…ØŸ", answer: "ÙŠØ§Ù‡Ù„Ø§ ÙˆØ§Ù„Ù„Ù‡ ÙˆØ³Ù‡Ù„Ø§ ÙˆÙ…Ø±Ø­Ø¨Ø§", hint: "ÙÙŠÙ‡Ø§ ØªØ±Ø­ÙŠØ¨ Ù‚ÙˆÙŠ (ÙŠØ§Ù‡Ù„Ø§...)", task: "Ø³Ø¬Ù„ÙŠ ÙÙˆÙŠØ³ ÙˆÙ‚ÙˆÙ„ÙŠÙ‡Ø§ Ø¨Ù†ÙØ³ Ù†Ø¨Ø±ØªÙŠ ğŸ˜‚", successMsg: "ØµØ­! ÙƒØ§Ù†Øª Ù…Ù† ÙƒÙ„ Ù‚Ù„Ø¨ÙŠ ÙˆØ§Ù„Ù„Ù‡ ğŸ¤" },
  { title: "4. ÙŠÙˆÙ… Ø§Ù„Ø§Ø±ØªØ¨Ø§Ø· (Ø§Ù„Ø¹Ù‚Ø¯) ğŸ’", type: "pin4", prompt: "ØªØ§Ø±ÙŠØ® Ø¹Ù‚Ø¯ Ù‚Ø±Ø§Ù†Ù†Ø§ (Ø§Ù„Ù…Ù„ÙƒØ©).\nÙŠÙˆÙ… 24 Ø´Ù‡Ø± 10.\nØ§ÙƒØªØ¨ÙŠÙ‡Ø§: 2410", answer: "2410", hint: "Ø´Ù‡Ø± Ø£ÙƒØªÙˆØ¨Ø±", task: "Ø¨ÙˆØ³Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù‡ÙˆØ§Ø¡ ğŸ˜˜", successMsg: "ÙŠÙˆÙ… ØµØ±ØªÙŠ Ø­Ù„Ø§Ù„ÙŠ ğŸ’" },
  { title: "5. Ø°ÙƒØ±Ù‰ Ø´Ù‚ÙŠÙ‘Ø© ğŸ˜‰", type: "pin4", prompt: "ØªØªØ°ÙƒØ±ÙŠÙ† ØªØ§Ø±ÙŠØ® Ø£ÙˆÙ„ 'Ù‚Ø¨ØµØ©'ØŸ ğŸ˜‚\nÙŠÙˆÙ… 25 Ø´Ù‡Ø± 10.\nØ§ÙƒØªØ¨ÙŠ: 2510", answer: "2510", hint: "Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ù‚Ø¯ Ø¨ÙŠÙˆÙ… ÙˆØ§Ø­Ø¯ Ø¨Ø³", task: "Ø§Ø±Ø³Ù„ÙŠ Ø¥ÙŠÙ…ÙˆØ¬ÙŠ ÙŠØ¶Ø­Ùƒ ğŸ˜‚", successMsg: "Ø£Ø­Ù„Ù‰ Ø°ÙƒØ±Ù‰ ÙˆØ£Ø­Ù„Ù‰ Ù‚Ø¨ØµØ© ğŸ˜‚â¤ï¸" },
  { title: "6. Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ù…Ù†ØªØ¸Ø± ğŸ‘°ğŸ»â€â™€ï¸", type: "pin4", prompt: "Ù…ØªÙ‰ Ù…ÙˆØ¹Ø¯ Ø²ÙˆØ§Ø¬Ù†Ø§ Ø¥Ù† Ø´Ø§Ø¡ Ø§Ù„Ù„Ù‡ØŸ\nÙŠÙˆÙ… 17 Ø´Ù‡Ø± 4.\nØ§ÙƒØªØ¨ÙŠ: 1704", answer: "1704", hint: "Ø³Ù†Ø© 2026.. Ø´Ù‡Ø± Ø£Ø¨Ø±ÙŠÙ„", task: "Ø¯Ø¹ÙˆØ© Ø­Ù„ÙˆØ© Ù…Ù† Ù‚Ù„Ø¨Ùƒ Ù„Ù†Ø§", successMsg: "ÙŠØ§ Ø±Ø¨ ØªÙ…Ù… Ù„Ù†Ø§ Ø¹Ù„Ù‰ Ø®ÙŠØ± ğŸ¤²ğŸ»" },
  { title: "7. Ø´Ù‡Ø± Ø§Ù„Ø¹Ø³Ù„ âœˆï¸", type: "pin4", prompt: "Ù…ØªÙ‰ ØªØ§Ø±ÙŠØ® Ø³ÙØ±ØªÙ†Ø§ØŸ\nÙŠÙˆÙ… 20 Ø´Ù‡Ø± 4.\nØ§ÙƒØªØ¨ÙŠ: 2004", answer: "2004", hint: "Ø¨Ø¹Ø¯ Ø§Ù„Ø²ÙˆØ§Ø¬ Ø¨Ù€ 3 Ø£ÙŠØ§Ù…", task: "Ø¬Ù‡Ø²ÙŠ Ø§Ù„Ø´Ù†Ø·Ø© (Ù…Ø¬Ø§Ø²ÙŠØ§Ù‹) ÙˆØ§Ø±Ù…Ø²ÙŠ Ø¨Ø·ÙŠØ§Ø±Ø© âœˆï¸", successMsg: "Ø¨Ù†Ø·ÙŠØ± Ù„Ø³Ø§Ø¨Ø¹ Ø³Ù…Ø§ Ù…Ù† Ø§Ù„ÙØ±Ø­Ø© â˜ï¸" },
  { title: "8. ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§Ø³Ù… ğŸ”¢", type: "choice", prompt: "ÙƒÙ… Ø¹Ø¯Ø¯ Ø­Ø±ÙˆÙ Ø§Ø³Ù… Ø­Ø¨ÙŠØ¨ÙƒØŸ", answer: "5", options: "4,5,6,7", hint: "Ø³ Ù„ ÙŠ ...", task: "Ø§ÙƒØªØ¨ÙŠ Ø§Ø³Ù…ÙŠ Ù…Ø²Ø®Ø±Ù", successMsg: "ÙŠØ§ Ø­Ù„Ùˆ Ø§Ø³Ù…ÙŠ ÙˆØ§Ù†ØªÙŠ ØªØ®ØªØ§Ø±ÙŠÙ†Ù‡" },
  { title: "9. Ù…Ø¹Ø§Ø¯Ù„Ø© Ø­Ø¨Ù†Ø§ â•", type: "choice", prompt: "Ø¥Ø°Ø§ Ø¬Ù…Ø¹Ù†Ø§ Ø¹Ø¯Ø¯ Ø­Ø±ÙˆÙ Ø§Ø³Ù…Ùƒ Ù…Ø¹ Ø¹Ø¯Ø¯ Ø­Ø±ÙˆÙ Ø§Ø³Ù…ÙŠ.. ÙƒÙ… ÙŠØ·Ù„Ø¹ Ø§Ù„Ù†Ø§ØªØ¬ØŸ", answer: "9", options: "8,9,10,11", hint: "Ø­Ø±ÙˆÙÙŠ 5.. ÙˆØ­Ø±ÙˆÙÙƒ 4", task: "Ø§Ø±Ø³Ù…ÙŠ Ù‚Ù„Ø¨ ÙˆØ§ÙƒØªØ¨ÙŠ Ø¯Ø§Ø®Ù„Ù‡ Ø±Ù‚Ù… 9", successMsg: "Ø±Ù‚Ù… Ø§Ù„ÙƒÙ…Ø§Ù„ ÙˆØ§Ù„Ø­Ø¨ â¤ï¸" },
  { title: "10. Ø§Ù„Ø£Ø±Ø´ÙŠÙ ğŸ“”", type: "text", prompt: "ÙƒÙŠÙ Ù‚Ø±Ø±Ù†Ø§ Ù†Ø³Ø¬Ù„ Ø°ÙƒØ±ÙŠØ§ØªÙ†Ø§ ÙˆÙ„Ø­Ø¸Ø§ØªÙ†Ø§ Ø§Ù„Ø­Ù„ÙˆØ©ØŸ", answer: "Ø¨Ø§Ù„Ø¯ÙØªØ±", hint: "Ø´ÙŠØ¡ Ù†ÙƒØªØ¨ ÙÙŠÙ‡...", task: "Ø§ÙƒØªØ¨ÙŠ: Ø£Ø­Ø¨Ùƒ ÙÙŠ Ø§Ù„Ø¯ÙØªØ± ÙˆØµÙˆØ±ÙŠÙ‡Ø§", successMsg: "Ø¹Ø´Ø§Ù† ØªØ¨Ù‚Ù‰ Ù„Ù„Ø¹Ù…Ø± ÙƒÙ„Ù‡ ğŸ“" },
  { title: "11. Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø®Ø§Øµ â™¥ï¸", type: "text", prompt: "ÙˆØ´ Ø§Ù„Ø±Ù…Ø² (Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ) Ø§Ù„Ù„ÙŠ Ø®ØµØµØªÙ‡ Ù„Ùƒ Ù„Ø­Ø§Ù„ÙƒØŸ\n(Ø§Ù†Ø³Ø®ÙŠÙ‡ ÙˆØ§Ù„ØµÙ‚ÙŠÙ‡)", answer: "â™¥ï¸", hint: "Ø§Ù„Ù‚Ù„Ø¨ Ø§Ù„Ø£Ø­Ù…Ø± Ø§Ù„ØºØ§Ù…Ù‚: â™¥ï¸", task: "Ø£Ø±Ø³Ù„ÙŠ Ø§Ù„Ø±Ù…Ø² Ù„ÙŠ Ø§Ù„Ø­ÙŠÙ†", successMsg: "Ø£Ù†ØªÙ Ø§Ù„Ù‚Ù„Ø¨ ÙƒÙ„Ù‡ â™¥ï¸" },
  { title: "Ø§Ù„Ù†Ù‡Ø§ÙŠØ© ğŸ", type: "text", prompt: "Ø¹Ø´Ø§Ù† ØªÙØªØ­ÙŠÙ† Ø§Ù„ÙƒÙ†Ø².. Ø§ÙƒØªØ¨ÙŠ Ø§Ù„Ø¬Ù…Ù„Ø© Ø§Ù„Ø³Ø­Ø±ÙŠØ©:\nØ£Ù†Ø§ Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø§Ø³ØªÙ„Ø§Ù…", answer: "Ø£Ù†Ø§ Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø§Ø³ØªÙ„Ø§Ù…", hint: "Ø¨Ø¯ÙˆÙ† Ø£ÙŠ ØªØºÙŠÙŠØ±", task: "Ø§Ø³ØªØ¹Ø¯ÙŠ!!", successMsg: "Ø£Ù„Ù Ù…Ø¨Ø±ÙˆÙƒ ÙŠØ§ Ø±ÙˆØ­ÙŠ! ğŸ‰" }
];

const DEFAULT_MOTIVATIONS = [
  { after: 3, message: "ğŸ’ª Ø±Ø§Ø¦Ø¹! 3 Ø¥Ø¬Ø§Ø¨Ø§Øª ØµØ­ÙŠØ­Ø©.. Ø§Ø³ØªÙ…Ø±ÙŠ ÙŠØ§ Ø¨Ø·Ù„Ø©!" },
  { after: 6, message: "ğŸ”¥ Ù†ØµÙ Ø§Ù„Ø·Ø±ÙŠÙ‚! Ø°Ø§ÙƒØ±ØªÙƒ Ø®ÙŠØ§Ù„ÙŠØ© ÙŠØ§ Ø¹Ù…Ø±ÙŠ" },
  { after: 9, message: "â­ ØªØ³Ø¹Ø© Ù…Ù† Ø§Ø«Ù†ÙŠ Ø¹Ø´Ø±! Ø£Ù†ØªÙ Ø£Ø³Ø·ÙˆØ±Ø©!" }
];

let stages = [];
let motivations = [];
let currentStageIdx = 0;

let gameStats = {
  totalAttempts: 0,
  correctAnswers: 0,
  wrongAnswers: 0,
  hintsUsed: 0,
  gamesCompleted: 0,
  totalTimeSeconds: 0,
  currentSessionStart: null
};

/* ===========================
   ğŸŒ Connection Monitor
=========================== */
const connection = {
  init() {
    window.addEventListener('online', () => this.update(true));
    window.addEventListener('offline', () => this.update(false));
    this.update(navigator.onLine);
  },
  update(isOnline) {
    const el = document.getElementById('connectionStatus');
    if (!el) return;
    if (isOnline) el.classList.remove('offline');
    else el.classList.add('offline');
  }
};

/* ===========================
   ğŸ¨ UI helpers
=========================== */
const ui = {
  toast(msg, type = 'normal') {
    const el = document.getElementById('toast');
    el.textContent = String(msg ?? '');
    el.className = type;
    el.style.display = 'block';
    setTimeout(() => { el.style.display = 'none'; }, 3000);
  },
  setLoading(on) {
    const el = document.getElementById('loader');
    if (!el) return;
    el.style.display = on ? 'block' : 'none';
  },
  confetti() {
    const colors = ['#d63384', '#ffffff', '#ff80ab', '#ffc107'];
    for (let i = 0; i < 60; i++) {
      const el = document.createElement('div');
      el.className = 'confetti';
      el.style.left = Math.random() * 100 + 'vw';
      el.style.top = (-10 - Math.random() * 30) + 'px';
      el.style.background = colors[Math.floor(Math.random() * colors.length)];
      el.style.animationDuration = (Math.random() * 2 + 1) + 's';
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 3200);
    }
  },
  showMotivation(msg) {
    const el = document.createElement('div');
    el.className = 'motivation-msg';
    el.innerHTML = `
      <div style="font-size:50px; margin-bottom:15px;">ğŸ‰</div>
      <p id="motMsg" style="margin:0; font-size:18px; line-height:1.6;"></p>
    `;
    document.body.appendChild(el);
    el.querySelector('#motMsg').textContent = String(msg ?? '');
    requestAnimationFrame(() => el.classList.add('show'));
    setTimeout(() => {
      el.classList.add('hide');
      setTimeout(() => el.remove(), 300);
    }, 3000);
  }
};

/* ===========================
   ğŸ“Š Stats
=========================== */
const stats = {
  load() {
    try {
      const saved = localStorage.getItem(STORAGE.stats);
      if (saved) Object.assign(gameStats, JSON.parse(saved));
    } catch (e) { console.warn("Stats load failed:", e); }
  },
  save() {
    try { localStorage.setItem(STORAGE.stats, JSON.stringify(gameStats)); }
    catch (e) { console.warn("Stats save failed:", e); }
  },
  show() {
    document.getElementById('totalAttempts').innerText = gameStats.totalAttempts;
    document.getElementById('correctAnswers').innerText = gameStats.correctAnswers;
    document.getElementById('wrongAnswers').innerText = gameStats.wrongAnswers;
    document.getElementById('hintsUsed').innerText = gameStats.hintsUsed;
    document.getElementById('totalTime').innerText = game.formatTime(gameStats.totalTimeSeconds);
    document.getElementById('gamesCompleted').innerText = gameStats.gamesCompleted;
    game.showScreen('screen-stats');
  },
  close() {
    if (currentStageIdx > 0 && currentStageIdx < stages.length) game.showScreen('screen-game');
    else game.showScreen('screen-start');
  },
  reset() {
    if (!confirm("Ù…ØªØ£ÙƒØ¯Ø© Ù…Ù† Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªØŸ")) return;
    gameStats = {
      totalAttempts: 0, correctAnswers: 0, wrongAnswers: 0, hintsUsed: 0,
      gamesCompleted: 0, totalTimeSeconds: 0, currentSessionStart: null
    };
    this.save();
    this.show();
    ui.toast("ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª", "success");
  },
  share() {
    const text = `ğŸ® Ø£Ù†Ù‡ÙŠØª Ù„Ø¹Ø¨Ø© "Ø±Ø­Ù„Ø© Ø­Ø¨Ù†Ø§" ğŸ’â¤ï¸

ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªÙŠ:
â€¢ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª: ${gameStats.totalAttempts}
â€¢ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©: ${gameStats.correctAnswers}
â€¢ Ø§Ù„ÙˆÙ‚Øª: ${game.formatTime(gameStats.totalTimeSeconds)}
â€¢ Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©: ${gameStats.gamesCompleted}

âœ¨ Ø°Ø§ÙƒØ±ØªÙŠ Ù‚ÙˆÙŠØ© ÙˆØ§Ù„Ø­Ø¨ Ø£Ù‚ÙˆÙ‰!`;

    if (navigator.share) {
      navigator.share({ title: 'Ø±Ø­Ù„Ø© Ø­Ø¨Ù†Ø§', text }).catch(() => this.copyToClipboard(text));
    } else {
      this.copyToClipboard(text);
    }
  },
  copyToClipboard(text) {
    if (navigator.clipboard?.writeText) {
      navigator.clipboard.writeText(text)
        .then(() => ui.toast("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù†ØªÙŠØ¬Ø©! ğŸ’•", "success"))
        .catch(() => ui.toast("Ø§Ù„Ù†Øµ Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©!", "success"));
    } else {
      ui.toast("Ø§Ù„Ù†Øµ Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©!", "success");
    }
  }
};

/* ===========================
   ğŸ’¾ Backup (export/import)
=========================== */
const backup = {
  show() { game.showScreen('screen-backup'); },
  close() {
    if (currentStageIdx > 0 && currentStageIdx < stages.length) game.showScreen('screen-game');
    else game.showScreen('screen-start');
  },
  export() {
    try {
      const data = {
        appVersion: APP_VERSION,
        timestamp: Date.now(),
        stages,
        motivations,
        progress: currentStageIdx,
        stats: gameStats
      };
      const jsonStr = JSON.stringify(data, null, 2);
      const blob = new Blob([jsonStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `love-hunt-backup-${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      ui.toast("âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!", "success");
    } catch (e) {
      console.error("Export failed:", e);
      ui.toast("âŒ ÙØ´Ù„ Ø§Ù„ØªØµØ¯ÙŠØ±", "error");
    }
  },
  import() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'application/json';
    input.onchange = (e) => {
      const file = e.target.files?.[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const data = JSON.parse(event.target.result);
          if (!data || !data.stages || !Array.isArray(data.stages)) throw new Error("Bad file");

          stages = data.stages;
          motivations = Array.isArray(data.motivations) ? data.motivations : DEFAULT_MOTIVATIONS;
          currentStageIdx = Number.isFinite(data.progress) ? data.progress : 0;

          if (data.stats && typeof data.stats === 'object') Object.assign(gameStats, data.stats);

          localStorage.setItem(STORAGE.data, JSON.stringify(stages));
          localStorage.setItem(STORAGE.motivations, JSON.stringify(motivations));
          localStorage.setItem(STORAGE.progress, String(currentStageIdx));
          stats.save();

          ui.toast("âœ… ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­!", "success");
          setTimeout(() => location.reload(), 800);
        } catch (err) {
          console.error(err);
          ui.toast("âŒ ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­", "error");
        }
      };
      reader.readAsText(file);
    };
    input.click();
  }
};

/* ===========================
   ğŸ® Game Logic
=========================== */
const game = {
  init() {
    connection.init();

    try {
      const savedData = localStorage.getItem(STORAGE.data);
      stages = savedData ? JSON.parse(savedData) : JSON.parse(JSON.stringify(DEFAULT_DATA));

      const savedMot = localStorage.getItem(STORAGE.motivations);
      motivations = savedMot ? JSON.parse(savedMot) : JSON.parse(JSON.stringify(DEFAULT_MOTIVATIONS));

      const savedProgress = localStorage.getItem(STORAGE.progress);
      if (savedProgress !== null) currentStageIdx = parseInt(savedProgress, 10) || 0;

      stats.load();

      if (currentStageIdx > 0 && currentStageIdx < stages.length) {
        this.showScreen('screen-game');
        this.render();
        if (!gameStats.currentSessionStart) gameStats.currentSessionStart = Date.now();
      }
      this.updateBackButton();
    } catch (e) {
      console.error("Initialization Error:", e);
      alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø©. Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
      this.resetOnlyOurKeys();
      location.reload();
    }

    this.registerServiceWorker();
  },

  resetOnlyOurKeys() {
    STORAGE.allKeys().forEach(k => localStorage.removeItem(k));
  },

  async registerServiceWorker() {
    try {
      if ('serviceWorker' in navigator) {
        await navigator.serviceWorker.register('./sw.js', { scope: './' });
      }
    } catch (e) {
      console.warn("SW register failed:", e);
    }
  },

  start() {
    currentStageIdx = 0;
    this.saveProgress();
    this.showScreen('screen-game');
    this.render();
    this.updateBackButton();
    gameStats.currentSessionStart = Date.now();
  },

  restart(full = false) {
    if (full || confirm("Ù…ØªØ£ÙƒØ¯Ø© ØªØ¨ÙŠÙ† ØªØ¹ÙŠØ¯ÙŠÙ† Ù…Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©ØŸ")) {
      currentStageIdx = 0;
      this.saveProgress();
      this.showScreen('screen-start');
      this.updateBackButton();
      gameStats.currentSessionStart = null;
    }
  },

  goBack() {
    if (currentStageIdx > 0) {
      currentStageIdx--;
      this.saveProgress();
      this.render();
      this.updateBackButton();
    }
  },

  updateBackButton() {
    const btn = document.getElementById('backBtn');
    const inGame = document.getElementById('screen-game').classList.contains('active');
    if (currentStageIdx > 0 && inGame) btn.classList.add('visible');
    else btn.classList.remove('visible');
  },

  render() {
    const data = stages[currentStageIdx];
    if (!data) return;

    document.getElementById('stageTitle').innerText = data.title;
    document.getElementById('stageCounter').innerText = `${currentStageIdx + 1} / ${stages.length}`;
    document.getElementById('stagePrompt').innerText = data.prompt;
    document.getElementById('stageTask').innerText = data.task || "Ø§Ø³ØªÙ…Ø±ÙŠ Ø¨Ø­Ø¨Ùƒ â¤ï¸";

    const imgEl = document.getElementById('stageImg');
    if (data.img && String(data.img).trim() !== "") {
      imgEl.src = data.img;
      imgEl.style.display = "block";
    } else {
      imgEl.style.display = "none";
      imgEl.removeAttribute('src');
    }

    const pct = ((currentStageIdx + 1) / stages.length) * 100;
    document.getElementById('progressBar').style.width = `${pct}%`;

    const container = document.getElementById('inputContainer');
    container.innerHTML = '';

    if (data.type === 'text') {
      container.innerHTML = `<input type="text" id="ansInput" placeholder="Ø§ÙƒØªØ¨ÙŠ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ù‡Ù†Ø§..." autocomplete="off">`;
      setTimeout(() => {
        const inp = document.getElementById('ansInput');
        if (inp) {
          inp.focus();
          inp.addEventListener("keypress", (e) => { if (e.key === "Enter") game.check(); });
        }
      }, 50);
    }
    else if (data.type === 'choice') {
      const opts = String(data.options || '').split(',').map(s => s.trim()).filter(Boolean);
      const grid = document.createElement('div');
      grid.className = 'options-grid';

      opts.forEach(val => {
        const item = document.createElement('div');
        item.className = 'option-card';
        item.textContent = val;
        item.addEventListener('click', () => this.selectOption(item, val));
        grid.appendChild(item);
      });

      const hidden = document.createElement('input');
      hidden.type = 'hidden';
      hidden.id = 'ansInput';

      container.appendChild(grid);
      container.appendChild(hidden);
    }
    else if (String(data.type).startsWith('pin')) {
      const len = data.type === 'pin3' ? 3 : 4;
      const grid = document.createElement('div');
      grid.className = 'pin-grid';

      for (let i = 0; i < len; i++) {
        const inp = document.createElement('input');
        inp.type = 'tel';
        inp.maxLength = 1;
        inp.className = 'pin-input';
        inp.id = `p${i}`;
        inp.inputMode = 'numeric';
        grid.appendChild(inp);
      }

      container.appendChild(grid);
      this.setupPinLogic(len);
    }
  },

  setupPinLogic(len) {
    const inputs = document.querySelectorAll('.pin-input');
    if (inputs[0]) {
      inputs[0].focus();
      inputs[0].addEventListener('paste', (e) => {
        const text = (e.clipboardData || window.clipboardData).getData('text') || '';
        const digits = text.replace(/\D/g, '').slice(0, len);
        if (digits.length === len) {
          e.preventDefault();
          for (let i = 0; i < len; i++) {
            const el = document.getElementById(`p${i}`);
            if (el) el.value = digits[i];
          }
          const last = document.getElementById(`p${len-1}`);
          if (last) last.focus();
        }
      });
    }

    inputs.forEach((input, idx) => {
      input.addEventListener('input', (e) => {
        e.target.value = (e.target.value || '').replace(/\D/g,'').slice(0,1);
        if (e.target.value && idx < len - 1) document.getElementById(`p${idx+1}`).focus();
      });
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Backspace' && !e.target.value && idx > 0) document.getElementById(`p${idx-1}`).focus();
        if (e.key === 'Enter') game.check();
      });
    });
  },

  selectOption(el, val) {
    document.querySelectorAll('.option-card').forEach(c => c.classList.remove('selected'));
    el.classList.add('selected');
    const hidden = document.getElementById('ansInput');
    if (hidden) hidden.value = val;
  },

  check() {
    const data = stages[currentStageIdx];
    let userAns = "";

    if (String(data.type).startsWith('pin')) {
      document.querySelectorAll('.pin-input').forEach(i => userAns += i.value);
    } else {
      const inp = document.getElementById('ansInput');
      userAns = inp ? inp.value : "";
    }

    if (!userAns) {
      ui.toast("âš ï¸ Ù„Ø§ ØªØ³ØªØ¹Ø¬Ù„ÙŠÙ†.. Ø¬Ø§ÙˆØ¨ÙŠ Ø£ÙˆÙ„!", "error");
      return;
    }

    gameStats.totalAttempts++;

    const cleanUser = this.normalize(userAns);
    const cleanCorrect = this.normalize(data.answer);

    const isCorrect = (cleanUser === cleanCorrect);

    if (isCorrect) {
      gameStats.correctAnswers++;
      this.handleSuccess(data);
    } else {
      gameStats.wrongAnswers++;
      stats.save();
      ui.toast("âŒ Ø®Ø·Ø£.. Ø­Ø§ÙˆÙ„ÙŠ ØªØªØ°ÙƒØ±ÙŠÙ† ğŸ˜‰", "error");
      if (navigator.vibrate) navigator.vibrate(200);
    }
  },

  normalize(text) {
    return String(text ?? '')
      .trim()
      .toLowerCase()
      .replace(/\s/g, '')
      .replace(/[Ø£Ø¥Ø¢]/g, 'Ø§')
      .replace(/Ø©/g, 'Ù‡')
      .replace(/Ù‰/g, 'ÙŠ');
  },

  handleSuccess(data) {
    ui.toast(data.successMsg || "âœ… Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©!", "success");
    ui.confetti();
    stats.save();

    setTimeout(() => {
      currentStageIdx++;
      this.saveProgress();
      this.checkMotivation();

      if (currentStageIdx >= stages.length) this.completeGame();
      else { this.render(); this.updateBackButton(); }
    }, 900);
  },

  checkMotivation() {
    motivations.forEach(mot => {
      if (gameStats.correctAnswers === mot.after) ui.showMotivation(mot.message);
    });
  },

  completeGame() {
    gameStats.gamesCompleted++;

    if (gameStats.currentSessionStart) {
      const timeSpent = Math.floor((Date.now() - gameStats.currentSessionStart) / 1000);
      gameStats.totalTimeSeconds += timeSpent;
      gameStats.currentSessionStart = null;

      document.getElementById('winAttempts').innerText = gameStats.totalAttempts;
      document.getElementById('winTime').innerText = this.formatTime(timeSpent);
    }

    stats.save();
    this.showScreen('screen-win');
  },

  formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  },

  showHint() {
    const data = stages[currentStageIdx];
    gameStats.hintsUsed++;
    stats.save();
    ui.toast("ğŸ’¡ " + (data.hint || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙ„Ù…ÙŠØ­"), "success");
  },

  saveProgress() {
    try { localStorage.setItem(STORAGE.progress, String(currentStageIdx)); }
    catch (e) { console.warn("Failed to save progress:", e); }
  },

  showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    const target = document.getElementById(id);
    if (target) target.classList.add('active');
    this.updateBackButton();
  }
};

/* ===========================
   ğŸ›  Admin Panel (minimal)
=========================== */
const admin = {
  toggleAccordion(idx) {
    document.querySelectorAll('.stage-editor').forEach((el, i) => {
      if (i === idx) el.classList.toggle('open');
      else el.classList.remove('open');
    });
  },

  renderList() {
    const list = document.getElementById('stagesList');
    list.innerHTML = '';
    list.style.display = 'block';
    document.getElementById('motivationsList').style.display = 'none';

    stages.forEach((s, idx) => {
      const div = document.createElement('div');
      div.className = 'stage-editor';
      div.innerHTML = `
        <div class="stage-header">
          <span>${escapeHTML(idx+1)}. ${escapeHTML(s.title)}</span>
          <span style="font-size:10px; opacity:0.6">${escapeHTML(s.type)}</span>
        </div>
        <div class="stage-body">
          <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø³Ø¤Ø§Ù„</label>
          <input type="text" value="${escapeHTML(s.title)}" data-idx="${idx}" data-key="title">

          <div style="display:flex; gap:10px">
            <div style="flex:1">
              <label>Ø§Ù„Ù†ÙˆØ¹</label>
              <select data-idx="${idx}" data-key="type">
                <option value="text" ${s.type==='text'?'selected':''}>Ù†Øµ</option>
                <option value="pin4" ${s.type==='pin4'?'selected':''}>Ø£Ø±Ù‚Ø§Ù… (4)</option>
                <option value="pin3" ${s.type==='pin3'?'selected':''}>Ø£Ø±Ù‚Ø§Ù… (3)</option>
                <option value="choice" ${s.type==='choice'?'selected':''}>Ø®ÙŠØ§Ø±Ø§Øª</option>
              </select>
            </div>
            <div style="flex:1">
              <label>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</label>
              <input type="text" value="${escapeHTML(s.answer)}" data-idx="${idx}" data-key="answer">
            </div>
          </div>

          <label>Ù†Øµ Ø§Ù„Ù„ØºØ²</label>
          <textarea rows="2" data-idx="${idx}" data-key="prompt">${escapeHTML(s.prompt)}</textarea>

          <div class="choice-only" style="${s.type==='choice'?'':'display:none'}">
            <label>Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª (Ø¨ÙŠÙ†Ù‡Ù… ÙØ§ØµÙ„Ø©)</label>
            <input type="text" value="${escapeHTML(s.options || '')}" data-idx="${idx}" data-key="options">
          </div>

          <label>Ø§Ù„ØªÙ„Ù…ÙŠØ­</label>
          <input type="text" value="${escapeHTML(s.hint || '')}" data-idx="${idx}" data-key="hint">

          <label>Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­</label>
          <input type="text" value="${escapeHTML(s.successMsg || '')}" data-idx="${idx}" data-key="successMsg">

          <label>Ø§Ù„Ù…Ù‡Ù…Ø©</label>
          <input type="text" value="${escapeHTML(s.task || '')}" data-idx="${idx}" data-key="task">

          <label>Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input type="text" value="${escapeHTML(s.img || '')}" data-idx="${idx}" data-key="img" placeholder="https://...">

          <div style="margin-top:15px; border-top:1px solid rgba(255,255,255,0.1); padding-top:10px; display:flex; gap:10px;">
            <button class="btn-small btn-secondary" type="button" onclick="admin.move(${idx}, -1)">â¬†ï¸</button>
            <button class="btn-small btn-secondary" type="button" onclick="admin.move(${idx}, 1)">â¬‡ï¸</button>
            <button class="btn-small btn-danger" type="button" onclick="admin.remove(${idx})" style="margin-right:auto">Ø­Ø°Ù</button>
          </div>
        </div>
      `;
      list.appendChild(div);

      div.querySelector('.stage-header').addEventListener('click', () => this.toggleAccordion(idx));
    });

    list.querySelectorAll('input[data-idx], textarea[data-idx], select[data-idx]').forEach(el => {
      el.addEventListener('change', () => {
        const idx = parseInt(el.getAttribute('data-idx'), 10);
        const key = el.getAttribute('data-key');
        const val = el.value;

        stages[idx][key] = val;

        if (key === 'type') {
          const parent = el.closest('.stage-body');
          const box = parent.querySelector('.choice-only');
          if (box) box.style.display = (val === 'choice') ? 'block' : 'none';
          if (val === 'choice' && !stages[idx].options) stages[idx].options = "1,2,3,4";
        }
      });
    });
  },

  addStage() {
    stages.push({ title: "Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯", type: "text", prompt: "Ø§Ù„Ø³Ø¤Ø§Ù„...", answer: "Ø§Ù„Ø¬ÙˆØ§Ø¨", hint: "", task: "", successMsg: "", img: "" });
    this.renderList();
    this.toggleAccordion(stages.length - 1);
  },

  remove(idx) {
    if (!confirm("Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„ØŸ")) return;
    stages.splice(idx, 1);
    this.renderList();
  },

  move(idx, dir) {
    if (idx + dir < 0 || idx + dir >= stages.length) return;
    [stages[idx], stages[idx + dir]] = [stages[idx + dir], stages[idx]];
    this.renderList();
  },

  editMotivations() {
    const list = document.getElementById('motivationsList');
    list.innerHTML = '<h3 style="margin-bottom:15px;">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªØ­ÙÙŠØ²ÙŠØ©</h3>';
    list.style.display = 'block';
    document.getElementById('stagesList').style.display = 'none';

    motivations.forEach((mot, idx) => {
      const div = document.createElement('div');
      div.className = 'stage-editor open';
      div.innerHTML = `
        <div class="stage-body">
          <label>Ø¨Ø¹Ø¯ Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª</label>
          <input type="number" value="${escapeHTML(mot.after)}" data-idx="${idx}" data-key="after">
          <label>Ø§Ù„Ø±Ø³Ø§Ù„Ø©</label>
          <textarea rows="2" data-idx="${idx}" data-key="message">${escapeHTML(mot.message)}</textarea>
          <button class="btn-small btn-danger" type="button" onclick="admin.removeMotivation(${idx})">Ø­Ø°Ù</button>
        </div>
      `;
      list.appendChild(div);
    });

    list.querySelectorAll('input[data-idx], textarea[data-idx]').forEach(el => {
      el.addEventListener('change', () => {
        const idx = parseInt(el.getAttribute('data-idx'), 10);
        const key = el.getAttribute('data-key');
        if (key === 'after') motivations[idx].after = parseInt(el.value, 10) || 0;
        else motivations[idx].message = el.value;
      });
    });

    const addBtn = document.createElement('button');
    addBtn.className = 'btn-small btn';
    addBtn.type = 'button';
    addBtn.innerText = '+ Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø©';
    addBtn.onclick = () => { motivations.push({ after: 3, message: "Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©" }); this.editMotivations(); };

    const backBtn = document.createElement('button');
    backBtn.className = 'btn-small btn-secondary';
    backBtn.type = 'button';
    backBtn.innerText = 'Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø£Ø³Ø¦Ù„Ø©';
    backBtn.onclick = () => this.renderList();
    backBtn.style.marginRight = '10px';

    list.appendChild(addBtn);
    list.appendChild(backBtn);
  },

  removeMotivation(idx) {
    if (!confirm("Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŸ")) return;
    motivations.splice(idx, 1);
    this.editMotivations();
  },

  save() {
    try {
      localStorage.setItem(STORAGE.data, JSON.stringify(stages));
      localStorage.setItem(STORAGE.motivations, JSON.stringify(motivations));
      ui.toast("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­! ğŸ’¾", "success");
      setTimeout(() => location.reload(), 600);
    } catch (e) {
      console.error(e);
      ui.toast("ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ (Storage)", "error");
    }
  },

  exportData() {
    const data = JSON.stringify({ stages, motivations }, null, 2);
    if (navigator.clipboard?.writeText) {
      navigator.clipboard.writeText(data).then(() => ui.toast("ØªÙ… Ø§Ù„Ù†Ø³Ø® ğŸ“‹", "success"))
        .catch(() => ui.toast("Ø§Ù†Ø³Ø® ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ù…Ù† Ø§Ù„Ù†Ø§ÙØ°Ø©", "success"));
    } else {
      prompt("Ø§Ù†Ø³Ø® Ù‡Ø°Ø§ Ø§Ù„Ù†Øµ:", data);
    }
  },

  importData() {
    const data = prompt("Ø§Ù„ØµÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ù†Ø§ (JSON):");
    if (!data) return;
    try {
      const parsed = JSON.parse(data);
      if (parsed.stages && Array.isArray(parsed.stages)) stages = parsed.stages;
      else if (Array.isArray(parsed)) stages = parsed;
      motivations = (parsed.motivations && Array.isArray(parsed.motivations)) ? parsed.motivations : DEFAULT_MOTIVATIONS;

      this.renderList();
      ui.toast("ØªÙ… Ø§Ù„Ù„ØµÙ‚ØŒ Ø§Ø¶ØºØ· Ø­ÙØ¸", "success");
    } catch (e) {
      ui.toast("Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ§Ù„Ø­", "error");
    }
  },

  resetFactory() {
    if (!confirm("Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ©ØŸ")) return;
    STORAGE.allKeys().forEach(k => localStorage.removeItem(k));
    location.reload();
  },

  close() {
    const panel = document.getElementById('adminPanel');
    panel.classList.remove('open');
    panel.setAttribute('aria-hidden', 'true');
  },

  open() {
    const panel = document.getElementById('adminPanel');
    panel.classList.add('open');
    panel.setAttribute('aria-hidden', 'false');
  }
};

async function requestAdminAccess() {
  const pin = prompt("Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ:");
  if (pin === null) return;

  try {
    ui.setLoading(true);
    const hashed = await sha256Hex(ADMIN_SALT + pin);
    ui.setLoading(false);

    if (hashed && hashed === ADMIN_PIN_HASH) {
      admin.open();
      admin.renderList();
    } else {
      ui.toast("Ø®Ø·Ø£ ğŸš«", "error");
    }
  } catch (e) {
    ui.setLoading(false);
    ui.toast("ØªØ¹Ø°Ø± Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù…Ø²", "error");
  }
}

document.addEventListener('DOMContentLoaded', () => {
  game.init();
});
</script>
</body>
</html>
