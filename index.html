<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#2c003e" />
  <meta name="description" content="Ù„Ø¹Ø¨Ø© ØªÙØ§Ø¹Ù„ÙŠØ© Ø±ÙˆÙ…Ø§Ù†Ø³ÙŠØ© - Ø±Ø­Ù„Ø© Ø¹Ø¨Ø± 4 Ù…Ø±Ø§Ø­Ù„" />
  <title>Ø±Ø­Ù„Ø© Ø­Ø¨Ù†Ø§: 4 Ù…Ø±Ø§Ø­Ù„</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary: #d63384;
      --primary-dark: #a61e63;
      --bg-gradient-1: #1a0029;
      --bg-gradient-2: #390050;
      --card-bg: rgba(255, 255, 255, 0.08);
      --text-main: #ffffff;
      --success: #00e676;
      --error: #ff5252;
      --warning: #ffc107;
      --mission: #ff6b35;
      --input-bg: rgba(0, 0, 0, 0.4);
      --border-radius: 20px;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      margin: 0;
      font-family: 'Tajawal', sans-serif;
      background: linear-gradient(135deg, var(--bg-gradient-1), var(--bg-gradient-2));
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow-x: hidden;
      padding: 15px;
    }

    body::before {
      content: '';
      position: fixed; inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
      pointer-events: none;
      z-index: -1;
    }

    .container { width: 100%; max-width: 520px; position: relative; padding-bottom: 60px; }

    .card {
      background: var(--card-bg);
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: var(--border-radius);
      padding: 24px;
      box-shadow: 0 15px 50px rgba(0,0,0,0.5);
      transition: transform 0.3s ease;
      animation: float 6s ease-in-out infinite;
    }

    @keyframes float {
      0% {transform: translateY(0px);}
      50% {transform: translateY(-10px);}
      100% {transform: translateY(0px);}
    }

    .btn {
      background: linear-gradient(45deg, var(--primary), var(--primary-dark));
      border: none; color: white; padding: 16px; border-radius: 16px;
      font-size: 16px; font-weight: 800; font-family: inherit; cursor: pointer;
      width: 100%; transition: 0.2s; margin-top: 15px;
      box-shadow: 0 5px 20px rgba(214, 51, 132, 0.4);
      position: relative; overflow: hidden;
      display: block;
    }
    .btn::after {
      content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: 0.5s;
    }
    .btn:hover::after { left: 100%; }
    .btn:active { transform: scale(0.97); }

    .btn-secondary { background: rgba(255,255,255,0.1); box-shadow: none; border: 1px solid rgba(255,255,255,0.1); }
    .btn-danger { background: rgba(255, 82, 82, 0.2); color: #ff8080; border: 1px solid #ff5252; box-shadow: none; }
    .btn-small { padding: 8px 15px; font-size: 13px; width: auto; display: inline-block; margin: 5px; }
    .btn-share { background: linear-gradient(45deg, #25D366, #128C7E); }
    .btn-mission { 
      background: linear-gradient(45deg, var(--mission), #e55d2d); 
      box-shadow: 0 5px 20px rgba(255, 107, 53, 0.5);
      animation: pulse-mission 2s infinite;
    }

    @keyframes pulse-mission {
      0%, 100% { transform: scale(1); box-shadow: 0 5px 20px rgba(255, 107, 53, 0.5); }
      50% { transform: scale(1.03); box-shadow: 0 8px 30px rgba(255, 107, 53, 0.7); }
    }

    input, textarea, select {
      width: 100%; padding: 15px; background: var(--input-bg);
      border: 1px solid rgba(255,255,255,0.1); border-radius: 14px;
      color: white; font-family: inherit; font-size: 16px; margin-bottom: 12px;
      outline: none; text-align: center;
    }
    input:focus, textarea:focus, select:focus { border-color: var(--primary); background: rgba(0,0,0,0.6); }

    .screen { display: none; opacity: 0; animation: fadeUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
    .screen.active { display: block; }
    @keyframes fadeUp { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }

    .progress-container { margin-bottom: 25px; position: relative; }
    .progress-bar { height: 8px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary), #ff80ab); width: 0%; transition: width 0.5s ease; }

    .phase-indicator {
      background: rgba(255,255,255,0.05);
      padding: 12px;
      border-radius: 12px;
      margin-bottom: 20px;
      border-right: 4px solid var(--primary);
      text-align: center;
    }
    .phase-indicator .phase-title {
      font-size: 18px;
      font-weight: 800;
      color: var(--primary);
      margin-bottom: 5px;
    }
    .phase-indicator .phase-subtitle {
      font-size: 13px;
      opacity: 0.75;
    }

    .pin-grid { display: flex; gap: 10px; justify-content: center; margin: 25px 0; direction: ltr; }
    .pin-input { width: 55px; height: 65px; font-size: 26px; border-radius: 16px; margin: 0; text-align:center; }

    .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 20px 0; }
    .option-card {
      background: rgba(255,255,255,0.05); padding: 18px; border-radius: 16px;
      text-align: center; cursor: pointer; border: 2px solid transparent;
      transition: 0.2s; font-weight: 600; user-select:none;
    }
    .option-card:active { transform: scale(0.95); }
    .option-card.selected { border-color: var(--primary); background: rgba(214, 51, 132, 0.15); font-weight: 800; }

    #toast {
      position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
      background: rgba(20, 20, 30, 0.95); padding: 15px 30px; border-radius: 50px;
      z-index: 9999; display: none; font-size: 15px; text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1);
      width: max-content; max-width: 90%;
    }
    #toast.success { border-color: var(--success); color: var(--success); }
    #toast.error { border-color: var(--error); color: var(--error); }

    .settings-btn, .stats-btn, .backup-btn, .back-btn {
      position: fixed;
      width: 45px; height: 45px; background: rgba(0,0,0,0.4);
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      cursor: pointer; z-index: 100; font-size: 22px; backdrop-filter: blur(5px);
      transition: 0.3s; border: none; color: white;
    }
    .settings-btn { top: 20px; left: 20px; }
    .stats-btn { top: 75px; left: 20px; }
    .backup-btn { top: 130px; left: 20px; }
    .back-btn { top: 20px; right: 20px; display: none; }
    .settings-btn:hover, .stats-btn:hover, .backup-btn:hover, .back-btn:hover { background: var(--primary); }
    .back-btn.visible { display: flex; }

    .admin-overlay {
      position: fixed; inset: 0; background: #1a1a2e; z-index: 2000;
      padding: 20px; overflow-y: auto; display: none;
    }
    .admin-overlay.open { display: block; animation: fadeIn 0.3s; }

    .phase-editor {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.1);
      margin-bottom: 15px; border-radius: 12px; overflow: hidden;
    }
    .phase-header {
      padding: 15px; display: flex; justify-content: space-between;
      align-items: center; cursor: pointer; background: linear-gradient(135deg, rgba(214, 51, 132, 0.2), rgba(166, 30, 99, 0.2));
      font-weight: 700; font-size: 16px;
    }
    .phase-body {
      padding: 15px; display: none; border-top: 1px solid rgba(255,255,255,0.05);
    }
    .phase-editor.open .phase-body { display: block; }

    .stage-editor {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.1);
      margin-bottom: 12px; border-radius: 12px; overflow: hidden;
    }
    .stage-header {
      padding: 15px; display: flex; justify-content: space-between;
      align-items: center; cursor: pointer; background: rgba(255,255,255,0.02);
    }
    .stage-body {
      padding: 15px; display: none; border-top: 1px solid rgba(255,255,255,0.05);
    }
    .stage-editor.open .stage-body { display: block; }

    .mission-editor {
      background: linear-gradient(135deg, rgba(255, 107, 53, 0.1), rgba(229, 93, 45, 0.1));
      border: 2px solid rgba(255, 107, 53, 0.3);
      padding: 15px;
      border-radius: 12px;
      margin: 15px 0;
    }

    .confetti { position: fixed; width: 10px; height: 10px; animation: fall linear forwards; z-index: 9998; }
    @keyframes fall { to { transform: translateY(110vh) rotate(720deg); } }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin: 20px 0;
    }
    .stat-card {
      background: rgba(255,255,255,0.05);
      padding: 15px;
      border-radius: 12px;
      text-align: center;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .stat-value {
      font-size: 28px;
      font-weight: 900;
      color: var(--primary);
      margin-bottom: 5px;
    }
    .stat-label { font-size: 13px; opacity: 0.75; }

    .phase-mission-screen {
      background: linear-gradient(135deg, rgba(255,107,53,0.15), rgba(229,93,45,0.15));
      border: 3px solid var(--mission);
      border-radius: 20px;
      padding: 30px;
      margin: 20px 0;
      text-align: center;
      box-shadow: 0 0 30px rgba(255,107,53,0.3);
      animation: glow-border 2s infinite;
    }

    @keyframes glow-border {
      0%, 100% { box-shadow: 0 0 20px rgba(255,107,53,0.3); }
      50% { box-shadow: 0 0 40px rgba(255,107,53,0.6); }
    }

    .phase-mission-screen .mission-icon {
      font-size: 80px;
      margin-bottom: 15px;
      animation: bounce 1s infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    .phase-mission-screen .mission-title {
      font-size: 28px;
      font-weight: 900;
      color: var(--mission);
      margin-bottom: 15px;
      text-shadow: 0 2px 10px rgba(255,107,53,0.5);
    }

    .phase-mission-screen .mission-desc {
      font-size: 17px;
      line-height: 1.8;
      margin-bottom: 20px;
      opacity: 0.95;
    }

    .secret-code-box {
      background: rgba(0,0,0,0.5);
      border: 2px dashed var(--warning);
      border-radius: 15px;
      padding: 20px;
      margin: 20px 0;
    }

    .secret-code-box .code-label {
      font-size: 14px;
      opacity: 0.8;
      margin-bottom: 10px;
    }

    .secret-code-box input {
      background: rgba(0,0,0,0.6);
      border: 2px solid var(--warning);
      color: var(--warning);
      font-size: 20px;
      font-weight: 800;
      letter-spacing: 2px;
      text-transform: uppercase;
      margin: 0;
    }

    .loader {
      display: none;
      position: fixed; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      width: 50px; height: 50px;
      border: 4px solid rgba(255,255,255,0.2);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      z-index: 10000;
    }
    @keyframes spin { to { transform: translate(-50%, -50%) rotate(360deg); } }
    @keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
    @keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.1);} 100% {transform: scale(1);} }

    @media (max-width: 600px) {
      .card { padding: 18px; }
      .options-grid { gap: 8px; }
      .option-card { padding: 14px; font-size: 14px; }
      .pin-input { width: 50px; height: 60px; font-size: 24px; }
      .stats-grid { grid-template-columns: 1fr; gap: 10px; }
      .phase-mission-screen { padding: 20px; }
      .phase-mission-screen .mission-icon { font-size: 60px; }
      .phase-mission-screen .mission-title { font-size: 22px; }
    }
  </style>
</head>

<body>
  <div id="toast" role="status" aria-live="polite"></div>
  <div class="loader" id="loader" aria-label="Loading"></div>

  <button class="settings-btn" type="button" onclick="requestAdminAccess()" aria-label="Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…">âš™ï¸</button>
  <button class="stats-btn" type="button" onclick="stats.show()" aria-label="Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª">ğŸ“Š</button>
  <button class="backup-btn" type="button" onclick="backup.show()" aria-label="Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ">ğŸ’¾</button>
  <button class="back-btn" id="backBtn" type="button" onclick="game.goBack()" aria-label="Ø±Ø¬ÙˆØ¹">â¬…ï¸</button>

  <div class="container" id="mainContainer">

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© -->
    <div id="screen-start" class="screen active">
      <div class="card" style="text-align:center; padding-top:40px; padding-bottom:40px;">
        <div style="font-size:70px; margin-bottom:15px; animation:pulse 2s infinite;">ğŸ’â¤ï¸</div>
        <h1 style="margin:0; font-size:32px;">Ø±Ø­Ù„Ø© Ø­Ø¨Ù†Ø§</h1>
        <p style="opacity:0.85; margin:15px 0 30px; line-height:1.8; font-size:16px;">
          Ø£Ø±Ø¨Ø¹ Ù…Ø±Ø§Ø­Ù„ Ù…Ù† Ø§Ù„Ø­Ø¨ ÙˆØ§Ù„Ø°ÙƒØ±ÙŠØ§Øª<br>
          Ù‡Ù„ Ø£Ù†ØªÙ Ù…Ø³ØªØ¹Ø¯Ø© Ù„Ù„Ø±Ø­Ù„Ø©ØŸ
        </p>
        
        <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:12px; margin:20px 0;">
          <div style="font-size:16px; font-weight:700; margin-bottom:10px;">ğŸ¯ Ø§Ù„Ù…Ø±Ø§Ø­Ù„:</div>
          <div style="font-size:14px; line-height:2; opacity:0.85;" id="phasesPreviewList">
            Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...
          </div>
        </div>

        <button class="btn" type="button" onclick="game.start()">Ù„Ù†Ø¨Ø¯Ø£ Ø§Ù„Ø±Ø­Ù„Ø© âœ¨</button>
      </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© -->
    <div id="screen-game" class="screen">
      <div class="phase-indicator">
        <div class="phase-title" id="phaseTitle">Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1</div>
        <div class="phase-subtitle" id="phaseProgress">Ø§Ù„Ø³Ø¤Ø§Ù„ 1 Ù…Ù† 3</div>
      </div>

      <div class="progress-container">
        <div class="progress-bar"><div class="progress-fill" id="progressBar"></div></div>
        <div style="display:flex; justify-content:space-between; font-size:12px; opacity:0.65; margin-top:8px;">
          <span id="stageCounter">1/15</span>
          <span onclick="game.restart()" style="cursor:pointer; text-decoration:underline;">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</span>
        </div>
      </div>

      <div class="card">
        <h2 id="stageTitle" style="margin:0 0 5px 0; color:var(--primary); font-size:20px;"></h2>
        <img id="stageImg" alt="" style="width:100%; border-radius:12px; margin-bottom:15px; display:none;">

        <p id="stagePrompt" style="font-size:18px; line-height:1.6; white-space:pre-line; margin-bottom:20px; font-weight:600;"></p>

        <div style="background:rgba(255,255,255,0.05); padding:12px; border-radius:12px; font-size:14px; margin-bottom:20px; border-right:4px solid var(--primary);">
          ğŸ«¶ <b>Ù…Ù‡Ù…ØªÙƒ:</b> <span id="stageTask" style="opacity:0.92;"></span>
        </div>

        <div id="inputContainer"></div>

        <div style="display:flex; gap:10px; margin-top:25px;">
          <button class="btn btn-secondary" type="button" style="flex:1;" onclick="game.showHint()">ØªÙ„Ù…ÙŠØ­ØŸ</button>
          <button class="btn" type="button" style="flex:2; margin-top:0;" onclick="game.check()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</button>
        </div>
      </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ù‡Ù…Ø© -->
    <div id="screen-mission" class="screen">
      <div class="card">
        <div class="phase-mission-screen">
          <div class="mission-icon" id="missionIcon">ğŸ¯</div>
          <div class="mission-title">Ù…Ø¨Ù€Ù€Ù€Ù€Ø±ÙˆÙƒ!</div>
          <div class="mission-desc" id="missionDesc">
            Ø£ÙƒÙ…Ù„ØªÙŠ Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­! ğŸ‰
          </div>
        </div>

        <div style="background:rgba(255,255,255,0.05); padding:20px; border-radius:12px; margin:20px 0; border: 2px solid var(--mission);">
          <div style="font-size:18px; font-weight:800; color:var(--mission); margin-bottom:15px; text-align:center;">
            ğŸ¯ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
          </div>
          <div style="font-size:16px; line-height:1.8; text-align:center;" id="missionTask">
            Ø§Ù„Ù…Ù‡Ù…Ø©...
          </div>
        </div>

        <div style="background:rgba(255,193,7,0.1); padding:15px; border-radius:10px; margin-bottom:20px; border-right: 4px solid var(--warning);">
          <p style="margin:0; font-size:14px; opacity:0.9; line-height:1.6;">
            ğŸ’¡ <strong>ØªÙ†Ø¨ÙŠÙ‡:</strong> Ø¨Ø¹Ø¯ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ù‡Ù…Ø©ØŒ Ø³ÙŠØ¸Ù‡Ø± Ù„ÙƒÙ ÙƒÙˆØ¯ Ø³Ø±ÙŠ.<br>
            Ø£Ø¯Ø®Ù„ÙŠ Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø£Ø¯Ù†Ø§Ù‡ Ù„Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©.
          </p>
        </div>

        <div class="secret-code-box">
          <div class="code-label">ğŸ” Ø£Ø¯Ø®Ù„ÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø±ÙŠ Ù‡Ù†Ø§:</div>
          <input type="text" id="secretCodeInput" placeholder="Ø£Ø¯Ø®Ù„ÙŠ Ø§Ù„ÙƒÙˆØ¯..." autocomplete="off">
        </div>

        <button class="btn btn-mission" type="button" onclick="game.verifySecretCode()">âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯ ÙˆØ§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</button>
      </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„ÙÙˆØ² -->
    <div id="screen-win" class="screen">
      <div class="card" style="text-align:center;">
        <div style="font-size:70px; margin-bottom:10px;">ğŸğŸ‘‘</div>
        <h1 style="color:var(--primary); margin-bottom:10px;">ÙˆØµÙ„ØªÙŠ Ù„Ù„Ù†Ù‡Ø§ÙŠØ©!</h1>
        <p style="opacity:0.92; line-height:1.6; font-size:17px;">
          Ø£ÙƒÙ…Ù„ØªÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ø¨Ù†Ø¬Ø§Ø­ ğŸ‰<br>
          ÙƒÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ø°ÙƒØ±ÙŠØ§Øª Ù‡ÙŠ ÙƒÙ†Ø²Ù†Ø§ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
        </p>

        <div style="background:rgba(255,255,255,0.05); padding:20px; border-radius:16px; margin:25px 0; border:1px dashed rgba(255,255,255,0.3);">
          <p style="margin:0 0 10px; font-size:14px; opacity:0.75;">Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±ÙŠØ©:</p>
          <h2 style="margin:0; color:var(--success); letter-spacing:1px;">Ø£Ù†ØªÙ Ø­Ø¨ÙŠ ÙˆØ­ÙŠØ§ØªÙŠ</h2>
        </div>

        <div class="stats-grid" style="margin:25px 0;">
          <div class="stat-card">
            <div class="stat-value" id="winAttempts">0</div>
            <div class="stat-label">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="winPhases">4</div>
            <div class="stat-label">Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</div>
          </div>
        </div>

        <button class="btn btn-share" type="button" onclick="stats.share()">Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù†ØªÙŠØ¬Ø© ğŸ“¤</button>
        <button class="btn btn-secondary" type="button" onclick="game.restart(true)">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
      </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
    <div id="screen-stats" class="screen">
      <div class="card">
        <h2 style="margin:0 0 20px 0; color:var(--primary); text-align:center;">ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h2>

        <div class="stats-grid">
          <div class="stat-card"><div class="stat-value" id="totalAttempts">0</div><div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª</div></div>
          <div class="stat-card"><div class="stat-value" id="correctAnswers">0</div><div class="stat-label">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©</div></div>
          <div class="stat-card"><div class="stat-value" id="wrongAnswers">0</div><div class="stat-label">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ø®Ø§Ø·Ø¦Ø©</div></div>
          <div class="stat-card"><div class="stat-value" id="hintsUsed">0</div><div class="stat-label">Ø§Ù„ØªÙ„Ù…ÙŠØ­Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©</div></div>
          <div class="stat-card"><div class="stat-value" id="phasesCompleted">0</div><div class="stat-label">Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</div></div>
          <div class="stat-card"><div class="stat-value" id="gamesCompleted">0</div><div class="stat-label">Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</div></div>
        </div>

        <button class="btn btn-danger" type="button" onclick="stats.reset()">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
        <button class="btn btn-secondary" type="button" onclick="stats.close()">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ -->
    <div id="screen-backup" class="screen">
      <div class="card">
        <h2 style="margin:0 0 20px 0; color:var(--primary); text-align:center;">ğŸ’¾ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</h2>

        <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:12px; margin-bottom:20px;">
          <p style="margin:0 0 10px; font-size:14px; opacity:0.85;">Ø§Ø­ÙØ¸ÙŠ ØªÙ‚Ø¯Ù…Ùƒ ÙÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø©:</p>
          <button class="btn" type="button" onclick="backup.export()">ğŸ“¥ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        </div>

        <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:12px; margin-bottom:20px;">
          <p style="margin:0 0 10px; font-size:14px; opacity:0.85;">Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù†Ø³Ø®Ø© Ø³Ø§Ø¨Ù‚Ø©:</p>
          <button class="btn btn-secondary" type="button" onclick="backup.import()">ğŸ“¤ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        </div>

        <div style="background:rgba(255,82,82,0.1); padding:15px; border-radius:12px; margin-bottom:20px; border:1px solid rgba(255,82,82,0.3);">
          <p style="margin:0; font-size:13px; opacity:0.95;">âš ï¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ ÙÙ‚Ø·</p>
        </div>

        <button class="btn btn-secondary" type="button" onclick="backup.close()">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>

  </div>

  <!-- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… -->
  <div id="adminPanel" class="admin-overlay" aria-hidden="true">
    <div class="container">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
        <h2 style="margin:0">ğŸ›  Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</h2>
        <button class="btn-small btn-secondary" type="button" onclick="admin.close()">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>

      <div style="background:#232336; padding:15px; border-radius:16px; margin-bottom:20px;">
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn-small btn" type="button" onclick="admin.addPhase()">+ Ù…Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
          <button class="btn-small btn-secondary" type="button" onclick="admin.exportData()">ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
          <button class="btn-small btn-secondary" type="button" onclick="admin.importData()">ğŸ“„ Ù„ØµÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
          <button class="btn-small btn-danger" type="button" onclick="admin.resetFactory()">ğŸ”„ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø£ØµÙ„ÙŠ</button>
        </div>
      </div>

      <div id="phasesPreviewList"></div>
      
      <button class="btn" style="margin-top:20px;" onclick="admin.save()">ğŸ’¾ Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>

      <button class="btn" type="button" style="margin-top:20px;" onclick="admin.save()">ğŸ’¾ Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
      <br><br><br>
    </div>
  </div>

<script>
/* ===========================
   Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
=========================== */
const APP_VERSION = 9;
const STORAGE = {
  data: `love_hunt_phases_v${APP_VERSION}`,
  progress: `love_hunt_progress_v${APP_VERSION}`,
  stats: `love_hunt_stats_v${APP_VERSION}`,
  allKeys() { return [this.data, this.progress, this.stats]; }
};

const ADMIN_PASSWORD = "1992";
// ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¨Ø³ÙŠØ·Ø©: 1992

/* ===========================
   Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
=========================== */
const DEFAULT_PHASES = [
  {
    id: 1,
    name: "ÙŠÙ„Ø§ Ù†Ø³Ø®Ù† Ù…Ø¹ Ø¨Ø¹Ø¶",
    icon: "ğŸ”¥",
    mission: {
      icon: "ğŸ“¸",
      description: "Ø§Ù„ØªÙ‚Ø·ÙŠ ØµÙˆØ±Ø© Ø³ÙŠÙ„ÙÙŠ ÙˆØ£Ù†ØªÙ ØªØ¨ØªØ³Ù…ÙŠÙ† Ø¨Ø£Ø¬Ù…Ù„ Ø§Ø¨ØªØ³Ø§Ù…Ø© ğŸ˜Š",
      task: "ØµÙˆØ±ÙŠ Ù†ÙØ³Ùƒ ÙˆØ£Ø±Ø³Ù„ÙŠ Ø§Ù„ØµÙˆØ±Ø©",
      secretCode: "Ø§Ø¨ØªØ³Ø§Ù…ØªÙƒ Ù†ÙˆØ±"
    },
    questions: [
      {
        title: "Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£ÙˆÙ„",
        type: "choice",
        prompt: "Ù…Ø§ Ù‡Ùˆ Ù„ÙˆÙ†Ùƒ Ø§Ù„Ù…ÙØ¶Ù„ØŸ",
        answer: "Ø£Ø²Ø±Ù‚",
        options: "Ø£Ø­Ù…Ø±,Ø£Ø²Ø±Ù‚,Ø£Ø®Ø¶Ø±,Ø£ØµÙØ±",
        hint: "Ù„ÙˆÙ† Ø§Ù„Ø³Ù…Ø§Ø¡ ÙˆØ§Ù„Ø¨Ø­Ø±...",
        task: "Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©",
        successMsg: "Ù…Ù…ØªØ§Ø²! Ø¨Ø¯Ø§ÙŠØ© Ø±Ø§Ø¦Ø¹Ø© ğŸ‰",
        img: ""
      },
      {
        title: "Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø«Ø§Ù†ÙŠ",
        type: "text",
        prompt: "Ù…Ø§ Ù‡Ùˆ Ø§Ø³Ù… Ø£ÙˆÙ„ Ù…Ø·Ø¹Ù… Ø°Ù‡Ø¨Ù†Ø§ Ù„Ù‡ Ø³ÙˆÙŠØ§Ù‹ØŸ",
        answer: "Ù…Ø§ÙƒØ¯ÙˆÙ†Ø§Ù„Ø¯Ø²",
        hint: "Ù…Ø·Ø¹Ù… ÙˆØ¬Ø¨Ø§Øª Ø³Ø±ÙŠØ¹Ø© Ù…Ø´Ù‡ÙˆØ±...",
        task: "Ø§ÙƒØªØ¨ÙŠ Ø§Ø³Ù… Ø§Ù„Ù…Ø·Ø¹Ù…",
        successMsg: "ØµØ­ÙŠØ­! Ø°ÙƒØ±Ù‰ Ø¬Ù…ÙŠÙ„Ø© ğŸ˜",
        img: ""
      },
      {
        title: "Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø«Ø§Ù„Ø«",
        type: "pin4",
        prompt: "ÙÙŠ Ø£ÙŠ Ø³Ù†Ø© Ø§Ù„ØªÙ‚ÙŠÙ†Ø§ØŸ\nÙ…Ø«Ø§Ù„: 2022",
        answer: "2022",
        hint: "ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ø´Ø±ÙŠÙ†Ø§Øª...",
        task: "Ø£Ø¯Ø®Ù„ÙŠ Ø§Ù„Ø³Ù†Ø©",
        successMsg: "Ø±Ø§Ø¦Ø¹! Ø£Ø¬Ù…Ù„ Ù„Ù‚Ø§Ø¡ â¤ï¸",
        img: ""
      }
    ]
  },
  {
    id: 2,
    name: "Ø§Ù„ÙƒÙ†Ø² Ø§Ù„Ù…ÙÙ‚ÙˆØ¯",
    icon: "ğŸ—ºï¸",
    mission: {
      icon: "ğŸ’",
      description: "Ø§Ø¨Ø­Ø«ÙŠ Ø¹Ù† Ø´ÙŠØ¡ Ø£Ø­Ù…Ø± ÙÙŠ Ø§Ù„ØºØ±ÙØ© ÙˆØµÙˆØ±ÙŠÙ‡ ğŸ“·",
      task: "Ø§Ø¹Ø«Ø±ÙŠ Ø¹Ù„Ù‰ Ø´ÙŠØ¡ Ø£Ø­Ù…Ø± ÙˆØµÙˆØ±ÙŠÙ‡",
      secretCode: "Ø§Ù„ÙƒÙ†Ø² Ø§Ù„Ø£Ø­Ù…Ø±"
    },
    questions: [
      {
        title: "Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙƒÙ†Ø² - 1",
        type: "choice",
        prompt: "Ù…Ø§ Ù‡ÙŠ Ù‡ÙˆØ§ÙŠØªÙŠ Ø§Ù„Ù…ÙØ¶Ù„Ø©ØŸ",
        answer: "Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©",
        options: "Ø§Ù„Ø±ÙŠØ§Ø¶Ø©,Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©,Ø§Ù„Ø·Ø¨Ø®,Ø§Ù„Ø±Ø³Ù…",
        hint: "Ø£Ø­Ø¨ Ø§Ù„ÙƒØªØ¨...",
        task: "Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ù„Ù‡ÙˆØ§ÙŠØ© Ø§Ù„ØµØ­ÙŠØ­Ø©",
        successMsg: "Ù…Ù…ØªØ§Ø²! ØªØ¹Ø±ÙÙŠÙ†ÙŠ Ø¬ÙŠØ¯Ø§Ù‹ ğŸ“š",
        img: ""
      },
      {
        title: "Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙƒÙ†Ø² - 2",
        type: "text",
        prompt: "Ù…Ø§ Ù‡Ùˆ Ù„Ù‚Ø¨ÙŠ Ø§Ù„Ù…ÙØ¶Ù„ Ø§Ù„Ø°ÙŠ ØªÙ†Ø§Ø¯ÙŠÙ†ÙŠ Ø¨Ù‡ØŸ",
        answer: "Ø­Ø¨ÙŠØ¨ÙŠ",
        hint: "ÙƒÙ„Ù…Ø© Ø­Ø¨...",
        task: "Ø§ÙƒØªØ¨ÙŠ Ø§Ù„Ù„Ù‚Ø¨",
        successMsg: "Ø¯Ø§Ø¦Ù…Ø§Ù‹ ÙÙŠ Ù‚Ù„Ø¨ÙŠ ğŸ’•",
        img: ""
      },
      {
        title: "Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙƒÙ†Ø² - 3",
        type: "choice",
        prompt: "ÙƒÙ… Ù…Ø±Ø© Ù‚Ù„Øª Ù„ÙƒÙ 'Ø£Ø­Ø¨Ùƒ' ÙÙŠ Ø£ÙˆÙ„ ÙŠÙˆÙ…ØŸ",
        answer: "10",
        options: "3,5,10,20",
        hint: "Ø±Ù‚Ù… Ù…ÙƒÙˆÙ† Ù…Ù† Ø®Ø§Ù†ØªÙŠÙ†...",
        task: "Ø®Ù…Ù†ÙŠ Ø§Ù„Ø¹Ø¯Ø¯",
        successMsg: "ÙˆÙ„Ø§ ÙŠØ²Ø§Ù„ Ø§Ù„Ø¹Ø¯Ø¯ ÙŠØ²Ø¯Ø§Ø¯! ğŸ˜Š",
        img: ""
      }
    ]
  },
  {
    id: 3,
    name: "Ø­Ø¨ÙŠ ÙˆØ­ÙŠØ§ØªÙŠ ÙˆÙ‚Ù„Ø¨ÙŠ",
    icon: "â¤ï¸",
    mission: {
      icon: "ğŸ’Œ",
      description: "Ø§ÙƒØªØ¨ÙŠ Ø±Ø³Ø§Ù„Ø© Ø­Ø¨ Ù‚ØµÙŠØ±Ø© (3 Ø£Ø³Ø·Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„) ÙˆØ§Ø±Ø³Ù„ÙŠÙ‡Ø§ âœï¸",
      task: "Ø¹Ø¨Ø±ÙŠ Ø¹Ù† Ù…Ø´Ø§Ø¹Ø±Ùƒ ÙÙŠ Ø±Ø³Ø§Ù„Ø©",
      secretCode: "Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù‚Ù„Ø¨"
    },
    questions: [
      {
        title: "Ù…Ù† Ø£Ø¹Ù…Ø§Ù‚ Ø§Ù„Ù‚Ù„Ø¨ - 1",
        type: "text",
        prompt: "Ø£ÙƒÙ…Ù„ÙŠ Ø§Ù„Ø¬Ù…Ù„Ø©: Ø£Ù†Ø§ Ø£Ø­Ø¨Ùƒ Ø£ÙƒØ«Ø± Ù…Ù†...",
        answer: "Ù†ÙØ³ÙŠ",
        hint: "ÙƒÙ„Ù…Ø© Ù…Ù† 4 Ø­Ø±ÙˆÙ...",
        task: "Ø£ÙƒÙ…Ù„ÙŠ Ø§Ù„Ø¬Ù…Ù„Ø©",
        successMsg: "ÙˆØ£Ù†Ø§ Ø£Ø­Ø¨Ùƒ Ø£ÙƒØ«Ø± Ù…Ù† ÙƒÙ„ Ø´ÙŠØ¡ â¤ï¸",
        img: ""
      },
      {
        title: "Ù…Ù† Ø£Ø¹Ù…Ø§Ù‚ Ø§Ù„Ù‚Ù„Ø¨ - 2",
        type: "choice",
        prompt: "Ù…Ø§ Ù‡Ùˆ Ø£Ø¬Ù…Ù„ Ø´ÙŠØ¡ ÙÙŠÙƒÙ Ù…Ù† ÙˆØ¬Ù‡Ø© Ù†Ø¸Ø±ÙŠØŸ",
        answer: "Ø§Ø¨ØªØ³Ø§Ù…ØªÙƒ",
        options: "Ø¹ÙŠÙˆÙ†Ùƒ,Ø§Ø¨ØªØ³Ø§Ù…ØªÙƒ,Ø¶Ø­ÙƒØªÙƒ,ØµÙˆØªÙƒ",
        hint: "ØªØ¶ÙŠØ¡ ÙˆØ¬Ù‡Ùƒ...",
        task: "Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©",
        successMsg: "Ø§Ø¨ØªØ³Ø§Ù…ØªÙƒ ØªÙ†ÙˆØ± Ø§Ù„Ø¯Ù†ÙŠØ§ ğŸ˜Š",
        img: ""
      },
      {
        title: "Ù…Ù† Ø£Ø¹Ù…Ø§Ù‚ Ø§Ù„Ù‚Ù„Ø¨ - 3",
        type: "text",
        prompt: "Ù…Ø§ Ù‡ÙŠ Ø§Ù„Ø£ØºÙ†ÙŠØ© Ø§Ù„ØªÙŠ ØªØ°ÙƒØ±Ùƒ Ø¨Ù†Ø§ØŸ",
        answer: "Ø£Ø­Ø¨Ùƒ",
        hint: "Ø§Ø³Ù… Ø¨Ø³ÙŠØ· ÙˆÙˆØ§Ø¶Ø­...",
        task: "Ø§ÙƒØªØ¨ÙŠ Ø§Ø³Ù… Ø§Ù„Ø£ØºÙ†ÙŠØ©",
        successMsg: "Ø£ØºÙ†ÙŠØªÙ†Ø§ Ø§Ù„Ø®Ø§ØµØ© ğŸµ",
        img: ""
      }
    ]
  },
  {
    id: 4,
    name: "Ù„Ù†ØµÙ„ Ù…Ø¹ Ø¨Ø¹Ø¶",
    icon: "ğŸ¯",
    mission: {
      icon: "ğŸ",
      description: "Ø³Ø¬Ù„ÙŠ Ù…Ù‚Ø·Ø¹ ÙÙŠØ¯ÙŠÙˆ Ù‚ØµÙŠØ± (10 Ø«ÙˆØ§Ù†ÙŠ) ÙˆØ£Ù†ØªÙ ØªÙ‚ÙˆÙ„ÙŠÙ†: Ø£Ø­Ø¨Ùƒ ğŸ’•",
      task: "Ø³Ø¬Ù„ÙŠ ÙÙŠØ¯ÙŠÙˆ Ù‚ØµÙŠØ±",
      secretCode: "Ù…Ø¹Ø§Ù‹ Ù„Ù„Ø£Ø¨Ø¯"
    },
    questions: [
      {
        title: "Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù†Ù‡Ø§ÙŠØ© - 1",
        type: "choice",
        prompt: "Ù…Ø§ Ù‡Ùˆ Ø­Ù„Ù…Ù†Ø§ Ø§Ù„Ù…Ø´ØªØ±ÙƒØŸ",
        answer: "Ø¨ÙŠØª Ø£Ø­Ù„Ø§Ù…Ù†Ø§",
        options: "Ø§Ù„Ø³ÙØ±,Ø¨ÙŠØª Ø£Ø­Ù„Ø§Ù…Ù†Ø§,Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©,Ø§Ù„Ø«Ø±ÙˆØ©",
        hint: "Ù…ÙƒØ§Ù† Ù†Ø¹ÙŠØ´ ÙÙŠÙ‡ Ø³ÙˆÙŠØ§Ù‹...",
        task: "Ø§Ø®ØªØ§Ø±ÙŠ Ø­Ù„Ù…Ù†Ø§",
        successMsg: "Ø³Ù†Ø­Ù‚Ù‚Ù‡ Ø³ÙˆÙŠØ§Ù‹ Ø¥Ù† Ø´Ø§Ø¡ Ø§Ù„Ù„Ù‡ ğŸ¡",
        img: ""
      },
      {
        title: "Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù†Ù‡Ø§ÙŠØ© - 2",
        type: "text",
        prompt: "Ø£ÙŠÙ† ØªØ±ÙŠØ¯ÙŠÙ† Ø£Ù† Ù†Ø°Ù‡Ø¨ ÙÙŠ Ø´Ù‡Ø± Ø§Ù„Ø¹Ø³Ù„ØŸ",
        answer: "Ø§Ù„Ù…Ø§Ù„Ø¯ÙŠÙ",
        hint: "Ø¬Ø²Ø± Ø§Ø³ØªÙˆØ§Ø¦ÙŠØ©...",
        task: "Ø§ÙƒØªØ¨ÙŠ Ø§Ù„ÙˆØ¬Ù‡Ø©",
        successMsg: "ÙˆØ¬Ù‡Ø© Ø£Ø­Ù„Ø§Ù…Ù†Ø§! ğŸï¸",
        img: ""
      },
      {
        title: "Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù†Ù‡Ø§ÙŠØ© - 3",
        type: "text",
        prompt: "Ù…Ø§ Ù‡ÙŠ Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø­Ø±ÙŠØ© Ù„Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©ØŸ\nØ§Ù„ØªÙ„Ù…ÙŠØ­: Ø£Ù†ØªÙ ___ Ùˆ ____",
        answer: "Ø­Ø¨ÙŠ ÙˆØ­ÙŠØ§ØªÙŠ",
        hint: "Ø£Ù†ØªÙ...",
        task: "Ø§ÙƒØªØ¨ÙŠ Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø­Ø±ÙŠØ©",
        successMsg: "Ù…Ø¨Ø±ÙˆÙƒ! ÙˆØµÙ„ØªÙ Ù„Ù„Ù†Ù‡Ø§ÙŠØ©! ğŸ‰ğŸ‘‘",
        img: ""
      }
    ]
  }
];

let phases = [];
let currentPhaseIdx = 0;
let currentQuestionIdx = 0;
let gameStats = {
  totalAttempts: 0,
  correctAnswers: 0,
  wrongAnswers: 0,
  hintsUsed: 0,
  phasesCompleted: 0,
  gamesCompleted: 0
};

/* ===========================
   Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
=========================== */
function escapeHTML(str) {
  return String(str ?? '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

// ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø¯Ø§Ù„Ø© sha256Hex - Ù„Ù… Ù†Ø¹Ø¯ Ø¨Ø­Ø§Ø¬Ø© Ù„Ù‡Ø§ Ù…Ø¹ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¨Ø³ÙŠØ·Ø©


/* ===========================
   ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
=========================== */
const ui = {
  toast(msg, type = 'normal') {
    const el = document.getElementById('toast');
    el.textContent = String(msg ?? '');
    el.className = type;
    el.style.display = 'block';
    setTimeout(() => { el.style.display = 'none'; }, 3000);
  },
  setLoading(on) {
    const el = document.getElementById('loader');
    if (!el) return;
    el.style.display = on ? 'block' : 'none';
  },
  confetti() {
    const colors = ['#d63384', '#ffffff', '#ff80ab', '#ffc107'];
    for (let i = 0; i < 60; i++) {
      const el = document.createElement('div');
      el.className = 'confetti';
      el.style.left = Math.random() * 100 + 'vw';
      el.style.top = (-10 - Math.random() * 30) + 'px';
      el.style.background = colors[Math.floor(Math.random() * colors.length)];
      el.style.animationDuration = (Math.random() * 2 + 1) + 's';
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 3200);
    }
  }
};

/* ===========================
   Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
=========================== */
const stats = {
  load() {
    try {
      const saved = localStorage.getItem(STORAGE.stats);
      if (saved) Object.assign(gameStats, JSON.parse(saved));
    } catch (e) { console.warn("Stats load failed:", e); }
  },
  save() {
    try { localStorage.setItem(STORAGE.stats, JSON.stringify(gameStats)); }
    catch (e) { console.warn("Stats save failed:", e); }
  },
  show() {
    document.getElementById('totalAttempts').innerText = gameStats.totalAttempts;
    document.getElementById('correctAnswers').innerText = gameStats.correctAnswers;
    document.getElementById('wrongAnswers').innerText = gameStats.wrongAnswers;
    document.getElementById('hintsUsed').innerText = gameStats.hintsUsed;
    document.getElementById('phasesCompleted').innerText = gameStats.phasesCompleted;
    document.getElementById('gamesCompleted').innerText = gameStats.gamesCompleted;
    game.showScreen('screen-stats');
  },
  close() {
    const currentPhase = phases[currentPhaseIdx];
    if (currentPhase && currentQuestionIdx < currentPhase.questions.length) {
      game.showScreen('screen-game');
    } else {
      game.showScreen('screen-start');
    }
  },
  reset() {
    if (!confirm("Ù…ØªØ£ÙƒØ¯Ø© Ù…Ù† Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªØŸ")) return;
    gameStats = {
      totalAttempts: 0, correctAnswers: 0, wrongAnswers: 0, hintsUsed: 0,
      phasesCompleted: 0, gamesCompleted: 0
    };
    this.save();
    this.show();
    ui.toast("ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª", "success");
  },
  share() {
    const text = `ğŸ® Ø£Ù†Ù‡ÙŠØª Ù„Ø¹Ø¨Ø© "Ø±Ø­Ù„Ø© Ø­Ø¨Ù†Ø§" - 4 Ù…Ø±Ø§Ø­Ù„ ğŸ’â¤ï¸

ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªÙŠ:
â€¢ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª: ${gameStats.totalAttempts}
â€¢ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©: ${gameStats.correctAnswers}
â€¢ Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©: ${gameStats.phasesCompleted}

âœ¨ Ø§Ù„Ø­Ø¨ ÙŠÙ†ØªØµØ± Ø¯Ø§Ø¦Ù…Ø§Ù‹!`;

    if (navigator.share) {
      navigator.share({ title: 'Ø±Ø­Ù„Ø© Ø­Ø¨Ù†Ø§', text }).catch(() => this.copyToClipboard(text));
    } else {
      this.copyToClipboard(text);
    }
  },
  copyToClipboard(text) {
    if (navigator.clipboard?.writeText) {
      navigator.clipboard.writeText(text)
        .then(() => ui.toast("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù†ØªÙŠØ¬Ø©! ğŸ’•", "success"))
        .catch(() => ui.toast("Ø§Ù„Ù†Øµ Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©!", "success"));
    } else {
      ui.toast("Ø§Ù„Ù†Øµ Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©!", "success");
    }
  }
};

/* ===========================
   Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
=========================== */
const backup = {
  show() { game.showScreen('screen-backup'); },
  close() {
    const currentPhase = phases[currentPhaseIdx];
    if (currentPhase && currentQuestionIdx < currentPhase.questions.length) {
      game.showScreen('screen-game');
    } else {
      game.showScreen('screen-start');
    }
  },
  export() {
    try {
      const data = {
        appVersion: APP_VERSION,
        timestamp: Date.now(),
        phases,
        progress: { phaseIdx: currentPhaseIdx, questionIdx: currentQuestionIdx },
        stats: gameStats
      };
      const jsonStr = JSON.stringify(data, null, 2);
      const blob = new Blob([jsonStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `love-hunt-backup-${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      ui.toast("âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!", "success");
    } catch (e) {
      console.error("Export failed:", e);
      ui.toast("âŒ ÙØ´Ù„ Ø§Ù„ØªØµØ¯ÙŠØ±", "error");
    }
  },
  import() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'application/json';
    input.onchange = (e) => {
      const file = e.target.files?.[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const data = JSON.parse(event.target.result);
          if (!data || !data.phases || !Array.isArray(data.phases)) throw new Error("Bad file");

          phases = data.phases;
          if (data.progress) {
            currentPhaseIdx = data.progress.phaseIdx || 0;
            currentQuestionIdx = data.progress.questionIdx || 0;
          }
          if (data.stats) Object.assign(gameStats, data.stats);

          localStorage.setItem(STORAGE.data, JSON.stringify(phases));
          localStorage.setItem(STORAGE.progress, JSON.stringify({ phaseIdx: currentPhaseIdx, questionIdx: currentQuestionIdx }));
          stats.save();

          ui.toast("âœ… ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­!", "success");
          setTimeout(() => location.reload(), 800);
        } catch (err) {
          console.error(err);
          ui.toast("âŒ ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­", "error");
        }
      };
      reader.readAsText(file);
    };
    input.click();
  }
};

/* ===========================
   Ù…Ù†Ø·Ù‚ Ø§Ù„Ù„Ø¹Ø¨Ø©
=========================== */
const game = {
  init() {
    try {
      const savedData = localStorage.getItem(STORAGE.data);
      phases = savedData ? JSON.parse(savedData) : JSON.parse(JSON.stringify(DEFAULT_PHASES));

      const savedProgress = localStorage.getItem(STORAGE.progress);
      if (savedProgress) {
        const progress = JSON.parse(savedProgress);
        currentPhaseIdx = progress.phaseIdx || 0;
        currentQuestionIdx = progress.questionIdx || 0;
      }

      stats.load();

      // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±Ø§Ø­Ù„ ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
      this.updatePhasesList();

      if (currentPhaseIdx > 0 || currentQuestionIdx > 0) {
        const currentPhase = phases[currentPhaseIdx];
        if (currentPhase && currentQuestionIdx < currentPhase.questions.length) {
          this.showScreen('screen-game');
          this.render();
        }
      }
      this.updateBackButton();
    } catch (e) {
      console.error("Initialization Error:", e);
      this.resetProgress();
      location.reload();
    }
  },

  updatePhasesList() {
    const listEl = document.getElementById('phasesPreviewList');
    if (!listEl) return;
    
    let html = '';
    phases.forEach((phase, idx) => {
      html += `${phase.icon} ${idx + 1}. ${escapeHTML(phase.name)}<br>`;
    });
    listEl.innerHTML = html;
  },

  resetProgress() {
    STORAGE.allKeys().forEach(k => localStorage.removeItem(k));
    currentPhaseIdx = 0;
    currentQuestionIdx = 0;
    gameStats = {
      totalAttempts: 0,
      correctAnswers: 0,
      wrongAnswers: 0,
      hintsUsed: 0,
      phasesCompleted: 0,
      gamesCompleted: 0
    };
  },

  start() {
    currentPhaseIdx = 0;
    currentQuestionIdx = 0;
    this.saveProgress();
    this.showScreen('screen-game');
    this.render();
    this.updateBackButton();
  },

  restart(full = false) {
    if (full || confirm("Ù…ØªØ£ÙƒØ¯Ø© ØªØ¨ÙŠÙ† ØªØ¹ÙŠØ¯ÙŠÙ† Ù…Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©ØŸ")) {
      this.resetProgress();
      this.showScreen('screen-start');
      this.updateBackButton();
    }
  },

  goBack() {
    if (currentQuestionIdx > 0) {
      currentQuestionIdx--;
    } else if (currentPhaseIdx > 0) {
      currentPhaseIdx--;
      const prevPhase = phases[currentPhaseIdx];
      currentQuestionIdx = prevPhase.questions.length - 1;
    }
    this.saveProgress();
    this.render();
    this.updateBackButton();
  },

  updateBackButton() {
    const btn = document.getElementById('backBtn');
    const inGame = document.getElementById('screen-game').classList.contains('active');
    if ((currentPhaseIdx > 0 || currentQuestionIdx > 0) && inGame) {
      btn.classList.add('visible');
    } else {
      btn.classList.remove('visible');
    }
  },

  render() {
    const phase = phases[currentPhaseIdx];
    if (!phase) return;

    const question = phase.questions[currentQuestionIdx];
    if (!question) return;

    // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø±Ø­Ù„Ø©
    document.getElementById('phaseTitle').innerHTML = `${phase.icon} Ø§Ù„Ù…Ø±Ø­Ù„Ø© ${currentPhaseIdx + 1}: ${phase.name}`;
    document.getElementById('phaseProgress').innerText = `Ø§Ù„Ø³Ø¤Ø§Ù„ ${currentQuestionIdx + 1} Ù…Ù† ${phase.questions.length}`;

    // Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
    let totalQuestions = 0;
    let completedQuestions = 0;
    phases.forEach((p, pIdx) => {
      totalQuestions += p.questions.length;
      if (pIdx < currentPhaseIdx) {
        completedQuestions += p.questions.length;
      } else if (pIdx === currentPhaseIdx) {
        completedQuestions += currentQuestionIdx;
      }
    });

    document.getElementById('stageTitle').innerText = question.title;
    document.getElementById('stageCounter').innerText = `${completedQuestions + 1} / ${totalQuestions}`;
    document.getElementById('stagePrompt').innerText = question.prompt;
    document.getElementById('stageTask').innerText = question.task || "Ø£Ø¬ÙŠØ¨ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¤Ø§Ù„";

    // Ø§Ù„ØµÙˆØ±Ø©
    const imgEl = document.getElementById('stageImg');
    if (question.img && String(question.img).trim() !== "") {
      imgEl.src = question.img;
      imgEl.style.display = "block";
    } else {
      imgEl.style.display = "none";
      imgEl.removeAttribute('src');
    }

    const pct = ((completedQuestions + 1) / totalQuestions) * 100;
    document.getElementById('progressBar').style.width = `${pct}%`;

    const container = document.getElementById('inputContainer');
    container.innerHTML = '';

    if (question.type === 'text') {
      container.innerHTML = `<input type="text" id="ansInput" placeholder="Ø§ÙƒØªØ¨ÙŠ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ù‡Ù†Ø§..." autocomplete="off">`;
      setTimeout(() => {
        const inp = document.getElementById('ansInput');
        if (inp) {
          inp.focus();
          inp.addEventListener("keypress", (e) => { if (e.key === "Enter") game.check(); });
        }
      }, 50);
    }
    else if (question.type === 'choice') {
      const opts = String(question.options || '').split(',').map(s => s.trim()).filter(Boolean);
      const grid = document.createElement('div');
      grid.className = 'options-grid';

      opts.forEach(val => {
        const item = document.createElement('div');
        item.className = 'option-card';
        item.textContent = val;
        item.addEventListener('click', () => this.selectOption(item, val));
        grid.appendChild(item);
      });

      const hidden = document.createElement('input');
      hidden.type = 'hidden';
      hidden.id = 'ansInput';

      container.appendChild(grid);
      container.appendChild(hidden);
    }
    else if (String(question.type).startsWith('pin')) {
      const len = question.type === 'pin3' ? 3 : 4;
      const grid = document.createElement('div');
      grid.className = 'pin-grid';

      for (let i = 0; i < len; i++) {
        const inp = document.createElement('input');
        inp.type = 'tel';
        inp.maxLength = 1;
        inp.className = 'pin-input';
        inp.id = `p${i}`;
        inp.inputMode = 'numeric';
        grid.appendChild(inp);
      }

      container.appendChild(grid);
      this.setupPinLogic(len);
    }
  },

  setupPinLogic(len) {
    const inputs = document.querySelectorAll('.pin-input');
    if (inputs[0]) inputs[0].focus();

    inputs.forEach((input, idx) => {
      input.addEventListener('input', (e) => {
        e.target.value = (e.target.value || '').replace(/\D/g,'').slice(0,1);
        if (e.target.value && idx < len - 1) document.getElementById(`p${idx+1}`).focus();
      });
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Backspace' && !e.target.value && idx > 0) document.getElementById(`p${idx-1}`).focus();
        if (e.key === 'Enter') game.check();
      });
    });
  },

  selectOption(el, val) {
    document.querySelectorAll('.option-card').forEach(c => c.classList.remove('selected'));
    el.classList.add('selected');
    const hidden = document.getElementById('ansInput');
    if (hidden) hidden.value = val;
  },

  check() {
    const phase = phases[currentPhaseIdx];
    const question = phase.questions[currentQuestionIdx];
    let userAns = "";

    if (String(question.type).startsWith('pin')) {
      document.querySelectorAll('.pin-input').forEach(i => userAns += i.value);
    } else {
      const inp = document.getElementById('ansInput');
      userAns = inp ? inp.value : "";
    }

    if (!userAns) {
      ui.toast("âš ï¸ Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¬ÙŠØ¨ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø£ÙˆÙ„Ø§Ù‹!", "error");
      return;
    }

    gameStats.totalAttempts++;

    const cleanUser = this.normalize(userAns);
    const cleanCorrect = this.normalize(question.answer);

    const isCorrect = (cleanUser === cleanCorrect);

    if (isCorrect) {
      gameStats.correctAnswers++;
      this.handleSuccess(question);
    } else {
      gameStats.wrongAnswers++;
      stats.save();
      ui.toast("âŒ Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©.. Ø­Ø§ÙˆÙ„ÙŠ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰", "error");
      if (navigator.vibrate) navigator.vibrate(200);
    }
  },

  normalize(text) {
    return String(text ?? '')
      .trim()
      .toLowerCase()
      .replace(/\s/g, '')
      .replace(/[Ø£Ø¥Ø¢]/g, 'Ø§')
      .replace(/Ø©/g, 'Ù‡')
      .replace(/Ù‰/g, 'ÙŠ');
  },

  handleSuccess(question) {
    ui.toast(question.successMsg || "âœ… Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©!", "success");
    ui.confetti();
    stats.save();

    setTimeout(() => {
      currentQuestionIdx++;
      this.saveProgress();

      const phase = phases[currentPhaseIdx];
      
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ø±Ø­Ù„Ø©
      if (currentQuestionIdx >= phase.questions.length) {
        // Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø±Ø­Ù„Ø©ØŒ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù‡Ù…Ø©
        this.showMission();
      } else {
        // Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ
        this.render();
        this.updateBackButton();
      }
    }, 900);
  },

  showMission() {
    const phase = phases[currentPhaseIdx];
    
    document.getElementById('missionIcon').innerText = phase.mission.icon;
    document.getElementById('missionDesc').innerHTML = `
      Ø£ÙƒÙ…Ù„ØªÙŠ ${phase.icon} <strong>${phase.name}</strong> Ø¨Ù†Ø¬Ø§Ø­! ğŸ‰<br>
      ${currentPhaseIdx < phases.length - 1 ? 'Ø§Ù„Ø¢Ù† ÙŠØ¬Ø¨ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ù‡Ù…Ø© Ù„Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©' : 'Ù…Ù‡Ù…Ø© Ø£Ø®ÙŠØ±Ø© Ù‚Ø¨Ù„ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©!'}
    `;
    document.getElementById('missionTask').innerText = phase.mission.description;

    // Ù…Ø³Ø­ Ø­Ù‚Ù„ Ø§Ù„ÙƒÙˆØ¯
    const codeInput = document.getElementById('secretCodeInput');
    if (codeInput) codeInput.value = '';

    this.showScreen('screen-mission');
  },

  verifySecretCode() {
    const phase = phases[currentPhaseIdx];
    const codeInput = document.getElementById('secretCodeInput');
    const userCode = codeInput ? codeInput.value : '';

    if (!userCode.trim()) {
      ui.toast("âš ï¸ Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø±ÙŠ!", "error");
      return;
    }

    const cleanUser = this.normalize(userCode);
    const cleanCorrect = this.normalize(phase.mission.secretCode);

    if (cleanUser === cleanCorrect) {
      ui.toast("âœ… Ø§Ù„ÙƒÙˆØ¯ ØµØ­ÙŠØ­! Ù…Ø¨Ø±ÙˆÙƒ!", "success");
      ui.confetti();
      
      gameStats.phasesCompleted++;
      stats.save();

      setTimeout(() => {
        currentPhaseIdx++;
        currentQuestionIdx = 0;
        this.saveProgress();

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù„Ø¹Ø¨Ø©
        if (currentPhaseIdx >= phases.length) {
          this.completeGame();
        } else {
          this.showScreen('screen-game');
          this.render();
          this.updateBackButton();
        }
      }, 1000);
    } else {
      gameStats.wrongAnswers++;
      stats.save();
      ui.toast("âŒ Ø§Ù„ÙƒÙˆØ¯ Ø®Ø§Ø·Ø¦! Ø­Ø§ÙˆÙ„ÙŠ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰", "error");
      if (navigator.vibrate) navigator.vibrate(200);
    }
  },

  completeGame() {
    gameStats.gamesCompleted++;
    stats.save();

    document.getElementById('winAttempts').innerText = gameStats.totalAttempts;
    document.getElementById('winPhases').innerText = phases.length;

    this.showScreen('screen-win');
  },

  showHint() {
    const phase = phases[currentPhaseIdx];
    const question = phase.questions[currentQuestionIdx];
    gameStats.hintsUsed++;
    stats.save();
    ui.toast("ğŸ’¡ " + (question.hint || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙ„Ù…ÙŠØ­"), "success");
  },

  saveProgress() {
    try {
      const progress = {
        phaseIdx: currentPhaseIdx,
        questionIdx: currentQuestionIdx
      };
      localStorage.setItem(STORAGE.progress, JSON.stringify(progress));
    } catch (e) {
      console.warn("Failed to save progress:", e);
    }
  },

  showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    const target = document.getElementById(id);
    if (target) target.classList.add('active');
    this.updateBackButton();
  }
};

/* ===========================
   Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
=========================== */
const admin = {
  togglePhaseAccordion(idx) {
    document.querySelectorAll('.phase-editor').forEach((el, i) => {
      if (i === idx) el.classList.toggle('open');
      else el.classList.remove('open');
    });
  },

  toggleQuestionAccordion(phaseIdx, qIdx) {
    const phaseEditor = document.querySelectorAll('.phase-editor')[phaseIdx];
    if (!phaseEditor) return;
    
    const questionEditors = phaseEditor.querySelectorAll('.stage-editor');
    questionEditors.forEach((el, i) => {
      if (i === qIdx) el.classList.toggle('open');
      else el.classList.remove('open');
    });
  },

  renderList() {
    const list = document.getElementById('adminPhasesList');
    list.innerHTML = '';

    phases.forEach((phase, phaseIdx) => {
      const div = document.createElement('div');
      div.className = 'phase-editor';
      
      const headerDiv = document.createElement('div');
      headerDiv.className = 'phase-header';
      headerDiv.innerHTML = `
        <span>${phase.icon} ${escapeHTML(phaseIdx + 1)}. ${escapeHTML(phase.name)}</span>
        <span style="font-size:11px; opacity:0.7">${phase.questions.length} Ø£Ø³Ø¦Ù„Ø©</span>
      `;
      headerDiv.addEventListener('click', () => this.togglePhaseAccordion(phaseIdx));
      
      const bodyDiv = document.createElement('div');
      bodyDiv.className = 'phase-body';
      
      // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø±Ø­Ù„Ø©
      bodyDiv.innerHTML = `
        <label style="font-weight:700; color:var(--primary)">Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø­Ù„Ø©</label>
        <input type="text" value="${escapeHTML(phase.name)}" data-phase="${phaseIdx}" data-key="name">
        
        <label style="font-weight:700; color:var(--primary)">Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…Ø±Ø­Ù„Ø©</label>
        <input type="text" value="${escapeHTML(phase.icon)}" data-phase="${phaseIdx}" data-key="icon" placeholder="Ù…Ø«Ø§Ù„: ğŸ”¥">
        
        <div class="mission-editor">
          <h4 style="margin:0 0 10px 0; color:var(--mission);">ğŸ¯ Ù…Ù‡Ù…Ø© Ø§Ù„Ù…Ø±Ø­Ù„Ø©</h4>
          
          <label>Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…Ù‡Ù…Ø©</label>
          <input type="text" value="${escapeHTML(phase.mission.icon)}" data-phase="${phaseIdx}" data-mission="icon" placeholder="Ù…Ø«Ø§Ù„: ğŸ“¸">
          
          <label>ÙˆØµÙ Ø§Ù„Ù…Ù‡Ù…Ø©</label>
          <textarea rows="2" data-phase="${phaseIdx}" data-mission="description">${escapeHTML(phase.mission.description)}</textarea>
          
          <label>Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø®ØªØµØ±</label>
          <input type="text" value="${escapeHTML(phase.mission.task)}" data-phase="${phaseIdx}" data-mission="task">
          
          <label style="font-weight:800; color:var(--warning)">ğŸ” Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø±ÙŠ Ù„Ù„Ù…Ù‡Ù…Ø©</label>
          <input type="text" value="${escapeHTML(phase.mission.secretCode)}" data-phase="${phaseIdx}" data-mission="secretCode" placeholder="Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø±ÙŠ..." style="background:rgba(255,193,7,0.1); border-color:var(--warning);">
        </div>
        
        <div style="margin:20px 0; padding-top:15px; border-top:2px solid rgba(255,255,255,0.1);">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h4 style="margin:0; color:var(--primary);">ğŸ“ Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø±Ø­Ù„Ø©</h4>
            <button class="btn-small btn" type="button" onclick="admin.addQuestion(${phaseIdx})">+ Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯</button>
          </div>
          <div id="questions-${phaseIdx}"></div>
        </div>
        
        <div style="margin-top:15px; padding-top:15px; border-top:1px solid rgba(255,255,255,0.1); display:flex; gap:10px; justify-content:flex-end;">
          <button class="btn-small btn-secondary" type="button" onclick="admin.movePhase(${phaseIdx}, -1)">â¬†ï¸ ØªØ­Ø±ÙŠÙƒ Ù„Ø£Ø¹Ù„Ù‰</button>
          <button class="btn-small btn-secondary" type="button" onclick="admin.movePhase(${phaseIdx}, 1)">â¬‡ï¸ ØªØ­Ø±ÙŠÙƒ Ù„Ø£Ø³ÙÙ„</button>
          <button class="btn-small btn-danger" type="button" onclick="admin.removePhase(${phaseIdx})">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù…Ø±Ø­Ù„Ø©</button>
        </div>
      `;
      
      div.appendChild(headerDiv);
      div.appendChild(bodyDiv);
      list.appendChild(div);
      
      // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
      bodyDiv.querySelectorAll('input[data-phase], textarea[data-phase]').forEach(el => {
        el.addEventListener('change', () => {
          const pIdx = parseInt(el.getAttribute('data-phase'), 10);
          const key = el.getAttribute('data-key');
          const missionKey = el.getAttribute('data-mission');
          
          if (key) {
            phases[pIdx][key] = el.value;
          } else if (missionKey) {
            phases[pIdx].mission[missionKey] = el.value;
          }
        });
      });
      
      // Ø±Ù†Ø¯Ø± Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
      this.renderQuestions(phaseIdx);
    });
  },

  renderQuestions(phaseIdx) {
    const phase = phases[phaseIdx];
    const container = document.getElementById(`questions-${phaseIdx}`);
    if (!container) return;
    
    container.innerHTML = '';
    
    phase.questions.forEach((q, qIdx) => {
      const div = document.createElement('div');
      div.className = 'stage-editor';
      
      const headerDiv = document.createElement('div');
      headerDiv.className = 'stage-header';
      headerDiv.innerHTML = `
        <span>${escapeHTML(qIdx + 1)}. ${escapeHTML(q.title)}</span>
        <span style="font-size:10px; opacity:0.6">${escapeHTML(q.type)}</span>
      `;
      headerDiv.addEventListener('click', () => this.toggleQuestionAccordion(phaseIdx, qIdx));
      
      const bodyDiv = document.createElement('div');
      bodyDiv.className = 'stage-body';
      bodyDiv.innerHTML = `
        <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø³Ø¤Ø§Ù„</label>
        <input type="text" value="${escapeHTML(q.title)}" data-phase="${phaseIdx}" data-question="${qIdx}" data-key="title">
        
        <div style="display:flex; gap:10px">
          <div style="flex:1">
            <label>Ù†ÙˆØ¹ Ø§Ù„Ø³Ø¤Ø§Ù„</label>
            <select data-phase="${phaseIdx}" data-question="${qIdx}" data-key="type">
              <option value="text" ${q.type==='text'?'selected':''}>Ù†Øµ</option>
              <option value="pin4" ${q.type==='pin4'?'selected':''}>Ø£Ø±Ù‚Ø§Ù… (4)</option>
              <option value="pin3" ${q.type==='pin3'?'selected':''}>Ø£Ø±Ù‚Ø§Ù… (3)</option>
              <option value="choice" ${q.type==='choice'?'selected':''}>Ø®ÙŠØ§Ø±Ø§Øª</option>
            </select>
          </div>
          <div style="flex:1">
            <label>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©</label>
            <input type="text" value="${escapeHTML(q.answer)}" data-phase="${phaseIdx}" data-question="${qIdx}" data-key="answer">
          </div>
        </div>
        
        <label>Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„</label>
        <textarea rows="2" data-phase="${phaseIdx}" data-question="${qIdx}" data-key="prompt">${escapeHTML(q.prompt)}</textarea>
        
        <div class="choice-only" style="${q.type==='choice'?'':'display:none'}">
          <label>Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª (Ø¨ÙŠÙ†Ù‡Ù… ÙØ§ØµÙ„Ø©)</label>
          <input type="text" value="${escapeHTML(q.options || '')}" data-phase="${phaseIdx}" data-question="${qIdx}" data-key="options">
        </div>
        
        <label>Ø§Ù„ØªÙ„Ù…ÙŠØ­</label>
        <input type="text" value="${escapeHTML(q.hint || '')}" data-phase="${phaseIdx}" data-question="${qIdx}" data-key="hint">
        
        <label>Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­</label>
        <input type="text" value="${escapeHTML(q.successMsg || '')}" data-phase="${phaseIdx}" data-question="${qIdx}" data-key="successMsg">
        
        <label>Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</label>
        <input type="text" value="${escapeHTML(q.task || '')}" data-phase="${phaseIdx}" data-question="${qIdx}" data-key="task">
        
        <label>Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
        <input type="text" value="${escapeHTML(q.img || '')}" data-phase="${phaseIdx}" data-question="${qIdx}" data-key="img" placeholder="https://...">
        
        <div style="margin-top:15px; padding-top:10px; border-top:1px solid rgba(255,255,255,0.05); display:flex; gap:10px;">
          <button class="btn-small btn-secondary" type="button" onclick="admin.moveQuestion(${phaseIdx}, ${qIdx}, -1)">â¬†ï¸</button>
          <button class="btn-small btn-secondary" type="button" onclick="admin.moveQuestion(${phaseIdx}, ${qIdx}, 1)">â¬‡ï¸</button>
          <button class="btn-small btn-danger" type="button" onclick="admin.removeQuestion(${phaseIdx}, ${qIdx})" style="margin-right:auto">ğŸ—‘ï¸ Ø­Ø°Ù</button>
        </div>
      `;
      
      div.appendChild(headerDiv);
      div.appendChild(bodyDiv);
      container.appendChild(div);
      
      // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
      bodyDiv.querySelectorAll('input[data-question], textarea[data-question], select[data-question]').forEach(el => {
        el.addEventListener('change', () => {
          const pIdx = parseInt(el.getAttribute('data-phase'), 10);
          const qIdx = parseInt(el.getAttribute('data-question'), 10);
          const key = el.getAttribute('data-key');
          
          phases[pIdx].questions[qIdx][key] = el.value;
          
          if (key === 'type') {
            const parent = el.closest('.stage-body');
            const box = parent.querySelector('.choice-only');
            if (box) box.style.display = (el.value === 'choice') ? 'block' : 'none';
            if (el.value === 'choice' && !phases[pIdx].questions[qIdx].options) {
              phases[pIdx].questions[qIdx].options = "Ø®ÙŠØ§Ø±1,Ø®ÙŠØ§Ø±2,Ø®ÙŠØ§Ø±3,Ø®ÙŠØ§Ø±4";
            }
          }
        });
      });
    });
  },

  addPhase() {
    phases.push({
      id: phases.length + 1,
      name: "Ù…Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©",
      icon: "â­",
      mission: {
        icon: "ğŸ¯",
        description: "ÙˆØµÙ Ø§Ù„Ù…Ù‡Ù…Ø©...",
        task: "Ù†Øµ Ø§Ù„Ù…Ù‡Ù…Ø©...",
        secretCode: "ÙƒÙˆØ¯ Ø³Ø±ÙŠ"
      },
      questions: []
    });
    this.renderList();
    this.togglePhaseAccordion(phases.length - 1);
  },

  removePhase(idx) {
    if (!confirm("Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø­Ù„Ø© ÙˆØ¬Ù…ÙŠØ¹ Ø£Ø³Ø¦Ù„ØªÙ‡Ø§ØŸ")) return;
    phases.splice(idx, 1);
    this.renderList();
  },

  movePhase(idx, dir) {
    if (idx + dir < 0 || idx + dir >= phases.length) return;
    [phases[idx], phases[idx + dir]] = [phases[idx + dir], phases[idx]];
    this.renderList();
  },

  addQuestion(phaseIdx) {
    phases[phaseIdx].questions.push({
      title: "Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯",
      type: "text",
      prompt: "Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„...",
      answer: "Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©",
      options: "",
      hint: "",
      task: "",
      successMsg: "",
      img: ""
    });
    this.renderQuestions(phaseIdx);
    const phaseEditor = document.querySelectorAll('.phase-editor')[phaseIdx];
    if (phaseEditor) {
      phaseEditor.classList.add('open');
      const lastQuestion = phaseEditor.querySelectorAll('.stage-editor')[phases[phaseIdx].questions.length - 1];
      if (lastQuestion) lastQuestion.classList.add('open');
    }
  },

  removeQuestion(phaseIdx, qIdx) {
    if (!confirm("Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„ØŸ")) return;
    phases[phaseIdx].questions.splice(qIdx, 1);
    this.renderQuestions(phaseIdx);
  },

  moveQuestion(phaseIdx, qIdx, dir) {
    const questions = phases[phaseIdx].questions;
    if (qIdx + dir < 0 || qIdx + dir >= questions.length) return;
    [questions[qIdx], questions[qIdx + dir]] = [questions[qIdx + dir], questions[qIdx]];
    this.renderQuestions(phaseIdx);
  },

  save() {
    try {
      localStorage.setItem(STORAGE.data, JSON.stringify(phases));
      ui.toast("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­! ğŸ’¾", "success");
      game.updatePhasesList();
      setTimeout(() => {
        this.close();
      }, 1000);
    } catch (e) {
      console.error(e);
      ui.toast("ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸", "error");
    }
  },

  exportData() {
    const data = JSON.stringify(phases, null, 2);
    if (navigator.clipboard?.writeText) {
      navigator.clipboard.writeText(data)
        .then(() => ui.toast("ØªÙ… Ø§Ù„Ù†Ø³Ø® ğŸ“‹", "success"))
        .catch(() => ui.toast("Ø§Ù†Ø³Ø® ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ù…Ù† Ø§Ù„Ù†Ø§ÙØ°Ø©", "success"));
    } else {
      prompt("Ø§Ù†Ø³Ø® Ù‡Ø°Ø§ Ø§Ù„Ù†Øµ:", data);
    }
  },

  importData() {
    const data = prompt("Ø§Ù„ØµÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ù†Ø§ (JSON):");
    if (!data) return;
    try {
      const parsed = JSON.parse(data);
      if (Array.isArray(parsed) && parsed.length > 0) {
        phases = parsed;
        this.renderList();
        ui.toast("ØªÙ… Ø§Ù„Ù„ØµÙ‚ØŒ Ø§Ø¶ØºØ· Ø­ÙØ¸", "success");
      } else {
        throw new Error("Invalid format");
      }
    } catch (e) {
      ui.toast("Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ§Ù„Ø­", "error");
    }
  },

  resetFactory() {
    if (!confirm("Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ©ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª!")) return;
    STORAGE.allKeys().forEach(k => localStorage.removeItem(k));
    location.reload();
  },

  close() {
    const panel = document.getElementById('adminPanel');
    panel.classList.remove('open');
    panel.setAttribute('aria-hidden', 'true');
  },

  open() {
    const panel = document.getElementById('adminPanel');
    panel.classList.add('open');
    panel.setAttribute('aria-hidden', 'false');
    this.renderList();
  }
};

function requestAdminAccess() {
  const password = prompt("Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…:");
  
  if (password === null) return;
  
  // Ø·Ø¨Ø§Ø¹Ø© Ù„Ù„ØªØ­Ù‚Ù‚
  console.log("âœ… ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¯Ø®Ù„Ø©:", password);
  console.log("âœ… ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:", ADMIN_PASSWORD);
  
  if (password === ADMIN_PASSWORD) {
    admin.open();
    ui.toast("Ù…Ø±Ø­Ø¨Ø§Ù‹ ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…! ğŸ‰", "success");
    console.log("âœ… ØªÙ… ÙØªØ­ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ù†Ø¬Ø§Ø­!");
  } else {
    ui.toast("âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©! Ø§Ù„ØµØ­ÙŠØ­Ø©: " + ADMIN_PASSWORD, "error");
    console.log("âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©!");
  }
}

/* ===========================
   Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
=========================== */
document.addEventListener('DOMContentLoaded', () => {
  game.init();
});
</script>
</body>
</html>
